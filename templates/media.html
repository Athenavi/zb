<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - 媒体库管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery-mousewheel/3.1.9/jquery.mousewheel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

        /* 文件卡片悬停效果 */
        .file-card {
            transition: all 0.3s ease;
            transform-origin: center;
        }

        .file-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* 进度条动画 */
        @keyframes progress-bar-stripes {
            0% {
                background-position-x: 1rem;
            }
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        /* 文件类型图标 */
        .file-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-size: 1.25rem;
        }

        /* 缩略图容器 */
        .thumbnail-container {
            position: relative;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            overflow: hidden;
            border-radius: 0.5rem;
        }

        .thumbnail-container img,
        .thumbnail-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 编辑模式复选框 */
        .edit-checkbox {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            display: none;
            z-index: 10;
        }

        /* 上传队列状态 */
        .upload-status {
            transition: all 0.3s ease;
        }

        /* 响应式网格 */
        @media (max-width: 640px) {
            .grid-cols-6 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .grid-cols-6 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        @media (min-width: 1025px) {
            .grid-cols-6 {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- 视频预览模态框 -->
<div id="video-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="relative w-full max-w-4xl mx-4">
        <button id="close-video"
                class="absolute -top-12 right-0 text-white text-2xl hover:text-gray-300 focus:outline-none">
            <i class="fas fa-times"></i>
        </button>
        <video id="video-player" controls class="w-full rounded-lg">
            您的浏览器不支持 HTML5 视频
        </video>
    </div>
</div>

<!-- 主容器 -->
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- 页面标题 -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">媒体库</h1>
        <p class="text-gray-600">管理和上传您的媒体文件</p>
    </div>

    <!-- 结果消息 -->
    <div id="result-message" class="mb-6 hidden"></div>

    <!-- 统计信息 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg mr-4">
                    <i class="fas fa-database text-blue-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">总存储 {{ stats.storage_used }}/{{ stats.storage_total }}</p>
                    <!-- 根据存储使用百分比显示不同颜色 -->
                    {% if stats.storage_percentage <= 50 %}
                        <p class="text-xl font-semibold text-green-600">{{ stats.storage_percentage }}%</p>
                    {% elif stats.storage_percentage <= 80 %}
                        <p class="text-xl font-semibold text-yellow-600">{{ stats.storage_percentage }}%</p>
                    {% elif stats.storage_percentage <= 100 %}
                        <p class="text-xl font-semibold text-orange-600">{{ stats.storage_percentage }}%</p>
                    {% else %}
                        <p class="text-xl font-semibold text-red-600">{{ stats.storage_percentage }}%</p>
                    {% endif %}
                </div>
            </div>
            <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg mr-4">
                    <i class="fas fa-images text-green-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">图片</p>
                    <p class="text-xl font-semibold">{{ stats.image_count }}</p>
                </div>
            </div>
            <div class="flex items-center">
                <div class="p-3 bg-purple-100 rounded-lg mr-4">
                    <i class="fas fa-video text-purple-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">视频</p>
                    <p class="text-xl font-semibold">{{ stats.video_count }}</p>
                </div>
            </div>
            <div class="flex items-center">
                <div class="p-3 bg-orange-100 rounded-lg mr-4">
                    <i class="fas fa-file-alt text-orange-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">其他</p>
                    <p class="text-xl font-semibold">{{ (pagination.total - stats.image_count - stats.video_count) if pagination else 0 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 控制栏 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex flex-wrap items-center gap-4">
                <h2 class="text-xl font-semibold text-gray-800">媒体文件</h2>
                <span class="text-sm text-gray-500">共 {{ pagination.total }} 个项目</span>
            </div>

            <div class="flex flex-wrap gap-3">
                <div class="flex rounded-lg overflow-hidden border border-gray-200">
                    <button class="filter-btn {% if media_type == 'all' %}bg-primary-500 text-white{% else %}bg-white text-gray-700 hover:bg-gray-50{% endif %} px-4 py-2"
                            type="button"
                            data-filter="all"
                            onclick="filterMedia('all')">
                        <i class="fas fa-layer-group mr-2"></i>全部
                    </button>
                    <button class="filter-btn {% if media_type == 'image' %}bg-primary-500 text-white{% else %}bg-white text-gray-700 hover:bg-gray-50{% endif %} px-4 py-2"
                            type="button"
                            data-filter="image"
                            onclick="filterMedia('image')">
                        <i class="fas fa-image mr-2"></i>图片
                    </button>
                    <button class="filter-btn {% if media_type == 'video' %}bg-primary-500 text-white{% else %}bg-white text-gray-700 hover:bg-gray-50{% endif %} px-4 py-2"
                            type="button"
                            data-filter="video"
                            onclick="filterMedia('video')">
                        <i class="fas fa-video mr-2"></i>视频
                    </button>
                </div>

                <button id="upload-btn"
                        class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center"
                        type="button">
                    <i class="fas fa-plus mr-2"></i>上传文件
                </button>
            </div>
        </div>

        <!-- 文件上传区 -->
        <div id="upload-section" class="p-6 border-b border-gray-100 bg-gray-50 hidden">
            {% if stats.canBeUploaded %}
                <form id="upload-form" action="/api/media/upload" method="POST" enctype="multipart/form-data"
                      class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-primary-400 transition-colors">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-2">拖放文件到此处上传</p>
                    <p class="text-sm text-gray-500 mb-4">支持 JPG, PNG, GIF, MP4, MOV 格式，支持大文件分块上传</p>
                    <input type="file" id="file-input" name="file" class="hidden" multiple>
                    <button type="button" id="select-files"
                            class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg">
                        选择文件
                    </button>
                </form>

                <!-- 上传控制按钮 -->
                <div id="upload-controls" class="mt-4 flex gap-2 hidden">
                    <button id="pause-upload"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg flex items-center"
                            type="button">
                        <i class="fas fa-pause mr-2"></i>暂停
                    </button>
                    <button id="resume-upload"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center hidden"
                            type="button">
                        <i class="fas fa-play mr-2"></i>继续
                    </button>
                    <button id="cancel-upload"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center"
                            type="button">
                        <i class="fas fa-times mr-2"></i>取消
                    </button>
                </div>

                <!-- 上传进度条 -->
                <div id="upload-progress" class="mt-6 hidden">
                    <div class="flex justify-between mb-2">
                        <span id="filename" class="text-sm font-medium text-gray-700"></span>
                        <span id="progress-text" class="text-sm font-medium text-gray-700">0 MB / 0 MB</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-value" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="upload-details" class="mt-2 text-xs text-gray-500 hidden">
                        <span id="chunk-info"></span> |
                        <span id="upload-speed">0 MB/s</span> |
                        <span id="time-remaining">0m 0s</span>
                    </div>
                    <div id="detailed-progress" class="mt-2 text-xs text-gray-500 hidden">
                        <span>已上传分块: </span>
                        <span id="uploaded-chunks">0/0</span> |
                        <span id="upload-status">准备中...</span>
                    </div>
                </div>
            {% else %}
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                        <div>
                            <h3 class="text-red-800 font-medium">存储空间不足</h3>
                            <p class="text-red-700 text-sm mt-1">您的存储空间已满，请清理一些文件或升级您的存储计划。</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- 上传队列 -->
        <div id="upload-queue" class="mt-6 hidden">
            <h3 class="text-lg font-medium text-gray-800 mb-3">上传队列</h3>
            <div id="queue-list" class="space-y-2"></div>
        </div>
    </div>

    <!-- 媒体文件网格 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <!-- 编辑工具栏 -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <button id="edit-mode-btn"
                        class="text-gray-600 hover:text-gray-800 px-3 py-2 rounded-lg flex items-center"
                        type="button">
                    <i class="fas fa-edit mr-2"></i>编辑模式
                </button>
            </div>
            <div>
                <button id="batch-delete-btn"
                        class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center"
                        type="button">
                    <i class="fas fa-trash mr-2"></i>删除选中项
                </button>
            </div>
        </div>

        <!-- 文件网格 -->
        {% if pagination.items %}
            <div id="gridContainer" class="grid grid-cols-6 gap-4">
                {% for media in pagination.items %}
                    <div class="file-card relative group" data-file-id="{{ media.id }}"
                         data-file-type="{{ media.file_hash.mime_type.split('/')[0] if media.file_hash and media.file_hash.mime_type else 'unknown' }}">
                        <!-- 编辑复选框 -->
                        <input type="checkbox"
                               class="edit-checkbox file-checkbox absolute top-2 left-2 z-10 rounded text-blue-600 focus:ring-blue-500"
                               data-file-id="{{ media.id }}" style="display: none;">

                        <!-- 文件内容 -->
                        <div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-200 hover:border-primary-300 transition-all duration-200">
                            {% if media.file_hash and media.file_hash.mime_type.startswith('image/') %}
                                <!-- 图片缩略图 -->
                                <div class="thumbnail-container">
                                    <a data-fancybox="gallery" href="/shared?data={{ media.hash }}">
                                        <img src="/thumbnail?data={{ media.hash }}"
                                             alt="{{ media.original_filename }}"
                                             class="object-cover w-full h-full"
                                             loading="lazy">
                                    </a>
                                </div>
                            {% elif media.file_hash and media.file_hash.mime_type.startswith('video/') %}
                                <!-- 视频缩略图 -->
                                <div class="thumbnail-container video-thumbnail cursor-pointer"
                                     data-hash="{{ media.hash }}">
                                    <img src="/thumbnail?data={{ media.hash }}"
                                         alt="{{ media.original_filename }}"
                                         class="object-cover w-full h-full"
                                         loading="lazy">
                                    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i class="fas fa-play-circle text-white text-3xl"></i>
                                    </div>
                                </div>
                            {% else %}
                                <!-- 其他文件类型图标 -->
                                <div class="thumbnail-container flex items-center justify-center bg-gray-100">
                                    <i class="fas fa-file-alt text-gray-400 text-3xl"></i>
                                </div>
                            {% endif %}

                            <!-- 文件信息 -->
                            <div class="p-3">
                                <h3 class="text-sm font-medium text-gray-900 truncate"
                                    title="{{ media.original_filename }}">
                                    {{ media.original_filename }}
                                </h3>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-xs text-gray-500">
                                        {% if media.file_hash %}
                                            {{ "%.1f"|format(media.file_hash.file_size / 1024 / 1024) }} MB
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                    <div class="flex space-x-1">
                                        <button class="text-gray-400 hover:text-blue-500 download-btn"
                                                data-hash="{{ media.hash }}" title="{{ media.original_filename }}">
                                            <i class="fas fa-link"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- 分页 -->
            {% if pagination.pages > 1 %}
                <div class="mt-8 flex justify-center">
                    <nav class="flex items-center space-x-2">
                        {% if pagination.has_prev %}
                            <a href="{{ url_for('media.media_v2', page=pagination.prev_num, type=media_type) }}"
                               class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        {% endif %}

                        {% for page_num in pagination.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != pagination.page %}
                                    <a href="{{ url_for('media.media_v2', page=page_num, type=media_type) }}"
                                       class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                                        {{ page_num }}
                                    </a>
                                {% else %}
                                    <span class="px-3 py-2 rounded-md text-sm font-medium text-white bg-primary-500">
                                        {{ page_num }}
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="px-3 py-2 rounded-md text-sm font-medium text-gray-500">
                                    ...
                                </span>
                            {% endif %}
                        {% endfor %}

                        {% if pagination.has_next %}
                            <a href="{{ url_for('media.media_v2', page=pagination.next_num, type=media_type) }}"
                               class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </nav>
                </div>
            {% endif %}
        {% else %}
            <!-- 空状态 -->
            <div class="text-center py-12">
                <i class="fas fa-cloud-upload-alt text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-1">暂无媒体文件</h3>
                <p class="text-gray-500 mb-6">上传您的第一个文件开始使用媒体库</p>
            </div>
        {% endif %}
    </div>
</div>
<script>
    // 大文件分块上传管理器
    class ChunkedUploader {
        constructor() {
            this.chunkSize = 5 * 1024 * 1024; // 5MB
            this.uploadId = null;
            this.file = null;
            this.totalChunks = 0;
            this.uploadedChunks = 0;
            this.isUploading = false;
            this.currentChunk = 0;
            this.uploadQueue = [];
            this.currentUpload = null;
            this.startTime = null;
        }

        // 初始化上传
        async initUpload(file) {
            this.file = file;
            this.totalChunks = Math.ceil(file.size / this.chunkSize);

            try {
                // 计算文件哈希（可选，用于秒传）
                const fileHash = await this.calculateFileHash(file);

                const response = await fetch('/api/upload/chunked/init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        filename: file.name,
                        total_size: file.size,
                        total_chunks: this.totalChunks,
                        file_hash: fileHash
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.uploadId = data.upload_id;

                    // 如果文件已存在，直接完成上传
                    if (data.file_exists) {
                        this.showResultMessage('文件已存在，秒传成功！', 'green');
                        return {success: true, instant: true};
                    }

                    // 如果支持断点续传
                    if (data.resume_upload) {
                        this.showResultMessage('检测到中断的上传，正在恢复...', 'green');
                        // 获取已上传的分块索引
                        const uploadedChunks = data.uploaded_chunks || [];
                        return {success: true, resume_upload: true, uploaded_chunks: uploadedChunks};
                    }

                    return {success: true};
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('初始化上传失败:', error);
                throw error;
            }
        }

        // 上传单个分块
        async uploadChunk(chunkIndex) {
            const start = chunkIndex * this.chunkSize;
            const end = Math.min(start + this.chunkSize, this.file.size);
            const chunk = this.file.slice(start, end);

            // 计算分块哈希
            const chunkHash = await this.calculateChunkHash(chunk);

            const formData = new FormData();
            formData.append('upload_id', this.uploadId);
            formData.append('chunk_index', chunkIndex);
            formData.append('chunk_hash', chunkHash);
            formData.append('chunk', chunk, `chunk_${chunkIndex}`);

            try {
                const response = await fetch('/api/upload/chunked/chunk', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                });

                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error(`上传分块 ${chunkIndex} 失败:`, error);
                return false;
            }
        }

        // 完成上传
        async completeUpload() {
            try {
                // 获取文件MIME类型
                const mimeType = this.file.type || await this.detectMimeType(this.file);

                const response = await fetch('/api/upload/chunked/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        upload_id: this.uploadId,
                        file_hash: await this.calculateFileHash(this.file),
                        mime_type: mimeType
                    })
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('完成上传失败:', error);
                throw error;
            }
        }

        // 计算文件哈希
        async calculateFileHash(file) {
            return new Promise((resolve) => {
                // 对于大文件，我们只计算前几个块的哈希值以提高性能
                const chunkSize = 5 * 1024 * 1024; // 5MB
                const chunksToHash = Math.min(2, Math.ceil(file.size / chunkSize)); // 最多计算前两个块

                const fileReader = new FileReader();
                const blob = file.slice(0, chunksToHash * chunkSize);
                fileReader.onload = async (e) => {
                    const buffer = e.target.result;
                    // 使用crypto API计算SHA-256
                    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    resolve(hashHex);
                };
                fileReader.readAsArrayBuffer(blob);
            });
        }

        // 计算分块哈希
        async calculateChunkHash(chunk) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const buffer = e.target.result;
                    crypto.subtle.digest('SHA-256', buffer).then(hash => {
                        const hashArray = Array.from(new Uint8Array(hash));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        resolve(hashHex);
                    });
                };
                reader.readAsArrayBuffer(chunk);
            });
        }

        // 检测文件MIME类型
        async detectMimeType(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const arr = new Uint8Array(e.target.result).subarray(0, 4);
                    let header = '';
                    for (let i = 0; i < arr.length; i++) {
                        header += arr[i].toString(16);
                    }

                    // 根据魔数判断文件类型
                    switch (header) {
                        case '89504e47':
                            resolve('image/png');
                            break;
                        case '47494638':
                            resolve('image/gif');
                            break;
                        case 'ffd8ffe0':
                        case 'ffd8ffe1':
                        case 'ffd8ffe2':
                            resolve('image/jpeg');
                            break;
                        case '52494646':
                            resolve('video/avi');
                            break;
                        case '66747970':
                            resolve('video/mp4');
                            break;
                        default:
                            resolve('application/octet-stream');
                    }
                };
                reader.readAsArrayBuffer(file.slice(0, 4));
            });
        }

        // 获取已上传的分块列表
        async getUploadedChunks() {
            if (!this.uploadId) return [];

            try {
                const response = await fetch(`/api/upload/chunked/chunks?upload_id=${this.uploadId}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                return data.uploaded_chunks || [];
            } catch (error) {
                console.error('获取已上传分块列表失败:', error);
                return [];
            }
        }

        // 获取上传进度
        async getProgress() {
            if (!this.uploadId) return null;

            try {
                const response = await fetch(`/api/upload/chunked/progress?upload_id=${this.uploadId}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('获取进度失败:', error);
                return null;
            }
        }

        // 取消上传
        async cancelUpload() {
            if (!this.uploadId) return;

            try {
                await fetch('/api/upload/chunked/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        upload_id: this.uploadId
                    })
                });
            } catch (error) {
                console.error('取消上传失败:', error);
            }
        }

        // 显示结果消息
        showResultMessage(text, color) {
            const messageDiv = document.getElementById('result-message');
            messageDiv.className = `px-4 py-2 rounded-lg ${color === 'green' ? 'bg-green-100 text-green-700 border border-green-400' :
                color === 'yellow' ? 'bg-yellow-100 text-yellow-700 border border-yellow-400' :
                    'bg-red-100 text-red-700 border border-red-400'}`;
            messageDiv.textContent = text;
            messageDiv.classList.remove('hidden');

            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
    }

    // 全局上传器实例
    const uploader = new ChunkedUploader();

    // 编辑模式切换
    let editMode = false;

    // 上传控制变量
    let isPaused = false;
    let currentUploadController = null;
    let currentFile = null;
    let uploadStartTime = null;
    let lastProgressUpdateTime = null;
    let lastUploadedBytes = 0;
    let uploadSpeed = 0;

    // 确保DOM加载完成后初始化事件监听器
    document.addEventListener('DOMContentLoaded', function () {
        // 初始化Fancybox
        if (typeof $ !== 'undefined' && $.fn.fancybox) {
            $('[data-fancybox="gallery"]').fancybox({
                buttons: [
                    "zoom",
                    "slideShow",
                    "fullScreen",
                    "download",
                    "thumbs",
                    "close"
                ],
                loop: true,
                protect: true
            });
        }

        // 上传文件显示/隐藏
        if (document.getElementById('upload-btn')) {
            document.getElementById('upload-btn').addEventListener('click', function () {
                const uploadSection = document.getElementById('upload-section');
                if (uploadSection) {
                    uploadSection.classList.toggle('hidden');
                }
            });
        }

        // 编辑模式切换
        if (document.getElementById('edit-mode-btn')) {
            document.getElementById('edit-mode-btn').addEventListener('click', function () {
                toggleEditMode();
            });
        }

        // 批量删除按钮
        if (document.getElementById('batch-delete-btn')) {
            document.getElementById('batch-delete-btn').addEventListener('click', function () {
                batchDelete();
            });
        }

        // 文件上传处理
        if (document.getElementById('file-input')) {
            document.getElementById('file-input').addEventListener('change', async function (e) {
                if (e.target.files.length > 0) {
                    const files = Array.from(e.target.files);

                    for (const file of files) {
                        await handleFileUpload(file);
                    }
                }
            });
        }

        // 下载文件
        document.querySelectorAll('.download-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const hashValue = btn.dataset.hash;
                const fileTitle = btn.title || '未命名文件';
                const url = `/shared?data=${hashValue}&title=${encodeURIComponent(fileTitle)}`;

                navigator.clipboard.writeText(document.location.origin + url)
                    .then(() => showResultMessage('链接已复制到剪切板', 'green'))
                    .catch(err => console.error('复制链接时出错:', err));
            });
        });

        // 视频预览
        document.querySelectorAll('.video-thumbnail').forEach(thumbnail => {
            thumbnail.addEventListener('click', function () {
                const videoSrc = `/shared?data=${this.dataset.hash}`;
                const videoPlayer = document.getElementById('video-player');
                if (videoPlayer) {
                    videoPlayer.src = videoSrc;
                    const modal = document.getElementById('video-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                    }
                    videoPlayer.play();
                }
            });
        });

        // 关闭视频
        if (document.getElementById('close-video')) {
            document.getElementById('close-video').addEventListener('click', function () {
                const videoPlayer = document.getElementById('video-player');
                if (videoPlayer) {
                    videoPlayer.pause();
                    videoPlayer.src = '';
                    const modal = document.getElementById('video-modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                }
            });
        }

        // 模拟文件卡片动画
        document.querySelectorAll('.file-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.05}s`;
        });

        // 排序按钮
        if (document.getElementById('sortButton')) {
            document.getElementById('sortButton').addEventListener('click', function () {
                var gridContainer = document.getElementById('gridContainer');
                if (gridContainer) {
                    var fileCards = Array.from(gridContainer.children);

                    // 反转顺序
                    fileCards.reverse();

                    // 清空网格容器
                    gridContainer.innerHTML = '';

                    // 将反转后的卡片重新插入
                    fileCards.forEach(function (card) {
                        gridContainer.appendChild(card);
                    });
                }
            });
        }

        // 选择文件按钮
        if (document.getElementById('select-files')) {
            document.getElementById('select-files').addEventListener('click', function () {
                const fileInput = document.getElementById('file-input');
                if (fileInput) {
                    fileInput.click();
                }
            });
        }

        // 添加上传控制按钮事件监听
        if (document.getElementById('pause-upload')) {
            document.getElementById('pause-upload').addEventListener('click', function () {
                if (typeof pauseUpload === 'function') {
                    pauseUpload();
                }
            });
        }
        if (document.getElementById('resume-upload')) {
            document.getElementById('resume-upload').addEventListener('click', function () {
                if (typeof resumeUpload === 'function') {
                    resumeUpload();
                }
            });
        }
        if (document.getElementById('cancel-upload')) {
            document.getElementById('cancel-upload').addEventListener('click', function () {
                if (typeof cancelUpload === 'function') {
                    cancelUpload();
                }
            });
        }

        // 文件选择框变更事件
        document.querySelectorAll('.file-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                updateSelectionCount();
            });
        });
    });

    // 处理文件上传的主要函数
    async function handleFileUpload(file) {
        try {
            // 显示上传区域
            const uploadSection = document.getElementById('upload-section');
            if (uploadSection) {
                uploadSection.classList.remove('hidden');
            }

            // 显示进度条和文件名
            document.getElementById('filename').textContent = file.name;
            document.getElementById('upload-progress').classList.remove('hidden');

            // 初始化上传
            const initResult = await uploader.initUpload(file);

            if (initResult.instant) {
                // 秒传成功
                showResultMessage('文件秒传成功！', 'green');
                resetUploadUI();
                setTimeout(() => location.reload(), 1500);
                return;
            }

            // 设置当前文件和开始时间
            currentFile = file;
            uploadStartTime = Date.now();
            lastProgressUpdateTime = Date.now();
            lastUploadedBytes = 0;

            // 显示详细进度信息
            document.getElementById('upload-details').classList.remove('hidden');
            document.getElementById('detailed-progress').classList.remove('hidden');
            document.getElementById('chunk-info').textContent = `总分块: ${uploader.totalChunks}`;
            document.getElementById('uploaded-chunks').textContent = `0/${uploader.totalChunks}`;
            document.getElementById('upload-status').textContent = '上传中...';

            // 显示控制按钮
            document.getElementById('upload-controls').classList.remove('hidden');

            // 获取需要上传的分块列表（支持断点续传）
            let chunksToUpload = [];
            if (initResult.resume_upload && initResult.uploaded_chunks) {
                // 断点续传模式 - 只上传未完成的分块
                chunksToUpload = Array.from({length: uploader.totalChunks}, (_, i) => i)
                    .filter(i => !initResult.uploaded_chunks.includes(i));
                uploader.uploadedChunks = initResult.uploaded_chunks.length;

                // 更新UI显示已上传的分块
                document.getElementById('uploaded-chunks').textContent = `${initResult.uploaded_chunks.length}/${uploader.totalChunks}`;
            } else {
                // 全新上传 - 上传所有分块
                chunksToUpload = Array.from({length: uploader.totalChunks}, (_, i) => i);
                uploader.uploadedChunks = 0;
            }

            // 开始上传分块
            isPaused = false;
            await uploadChunksSequentially(chunksToUpload);

        } catch (error) {
            console.error('上传初始化失败:', error);
            showResultMessage('上传失败: ' + error.message, 'red');
            resetUploadUI();
        }
    }

    // 顺序上传分块
    async function uploadChunksSequentially(chunksToUpload) {
        try {
            for (let i = 0; i < chunksToUpload.length; i++) {
                // 检查是否暂停
                while (isPaused) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const chunkIndex = chunksToUpload[i];

                // 更新UI状态
                document.getElementById('upload-status').textContent = `正在上传分块 ${chunkIndex + 1}/${uploader.totalChunks}`;

                // 上传单个分块
                const success = await uploader.uploadChunk(chunkIndex);

                if (success) {
                    uploader.uploadedChunks++;

                    // 更新进度条
                    const progressPercent = (uploader.uploadedChunks / uploader.totalChunks) * 100;
                    document.getElementById('progress-value').style.width = `${progressPercent}%`;

                    // 更新已上传分块数
                    document.getElementById('uploaded-chunks').textContent = `${uploader.uploadedChunks}/${uploader.totalChunks}`;

                    // 更新上传速度和剩余时间
                    updateUploadStats();
                } else {
                    throw new Error(`分块 ${chunkIndex} 上传失败`);
                }
            }

            // 所有分块上传完成，通知服务器合并文件
            const completeResult = await uploader.completeUpload();

            if (completeResult.success) {
                showResultMessage('文件上传成功！', 'green');
                resetUploadUI();
                setTimeout(() => location.reload(), 1500);
            } else {
                throw new Error(completeResult.error || '文件合并失败');
            }

        } catch (error) {
            console.error('上传过程中发生错误:', error);
            showResultMessage('上传失败: ' + error.message, 'red');
            resetUploadUI();
        }
    }

    // 更新上传统计信息（速度和剩余时间）
    function updateUploadStats() {
        if (!uploadStartTime) return;

        const now = Date.now();
        const elapsedTime = (now - uploadStartTime) / 1000; // 秒
        const uploadedBytes = uploader.uploadedChunks * uploader.chunkSize;
        const totalBytes = uploader.totalChunks * uploader.chunkSize;

        // 计算上传速度 (bytes/second)
        const deltaTime = (now - lastProgressUpdateTime) / 1000; // 秒
        if (deltaTime > 0) {
            uploadSpeed = (uploadedBytes - lastUploadedBytes) / deltaTime;
            lastUploadedBytes = uploadedBytes;
            lastProgressUpdateTime = now;
        }

        // 更新已上传大小显示
        const uploadedMB = (uploadedBytes / (1024 * 1024)).toFixed(2);
        const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);
        document.getElementById('progress-text').textContent = `${uploadedMB} MB / ${totalMB} MB`;

        // 更新速度显示
        const speedMBps = (uploadSpeed / (1024 * 1024)).toFixed(2);
        document.getElementById('upload-speed').textContent = `${speedMBps} MB/s`;

        // 计算剩余时间
        const remainingBytes = totalBytes - uploadedBytes;
        const remainingTimeSeconds = uploadSpeed > 0 ? remainingBytes / uploadSpeed : 0;
        const minutes = Math.floor(remainingTimeSeconds / 60);
        const seconds = Math.floor(remainingTimeSeconds % 60);
        document.getElementById('time-remaining').textContent = `${minutes}m ${seconds}s`;
    }

    // 暂停上传
    function pauseUpload() {
        isPaused = true;
        document.getElementById('pause-upload').classList.add('hidden');
        document.getElementById('resume-upload').classList.remove('hidden');
        document.getElementById('upload-status').textContent = '已暂停';
        showResultMessage('上传已暂停', 'yellow');
    }

    // 恢复上传
    function resumeUpload() {
        isPaused = false;
        document.getElementById('resume-upload').classList.add('hidden');
        document.getElementById('pause-upload').classList.remove('hidden');
        document.getElementById('upload-status').textContent = '恢复上传中...';
        showResultMessage('上传已恢复', 'green');
    }

    // 取消上传
    async function cancelUpload() {
        try {
            if (uploader.uploadId) {
                await uploader.cancelUpload();
            }

            // 重置UI
            resetUploadUI();
            showResultMessage('上传已取消', 'yellow');
        } catch (error) {
            console.error('取消上传失败:', error);
            showResultMessage('取消上传失败: ' + error.message, 'red');
        }
    }

    // 重置上传UI
    function resetUploadUI() {
        // 隐藏进度条和控制按钮
        document.getElementById('upload-progress').classList.add('hidden');
        document.getElementById('upload-controls').classList.add('hidden');
        document.getElementById('upload-details').classList.add('hidden');
        document.getElementById('detailed-progress').classList.add('hidden');

        // 重置进度条
        document.getElementById('progress-value').style.width = '0%';

        // 清空文件输入框
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.value = '';
        }

        // 重置变量
        isPaused = false;
        currentFile = null;
        uploadStartTime = null;
        lastProgressUpdateTime = null;
        lastUploadedBytes = 0;
        uploadSpeed = 0;
    }

    function toggleEditMode() {
        editMode = !editMode;
        const checkboxes = document.querySelectorAll('.edit-checkbox');
        const batchBtn = document.getElementById('batch-delete-btn');
        const editBtn = document.getElementById('edit-mode-btn');

        checkboxes.forEach(checkbox => {
            checkbox.style.display = editMode ? 'block' : 'none';
        });
        if (batchBtn) {
            batchBtn.classList.toggle('hidden', !editMode);
        }
        if (editBtn) {
            editBtn.innerHTML = editMode ? '<i class="fas fa-times mr-2"></i>退出编辑' : '<i class="fas fa-edit mr-2"></i>编辑模式';
        }
    }

    // 批量删除
    async function batchDelete() {
        const ids = Array.from(document.querySelectorAll('.file-checkbox:checked'))
            .map(checkbox => checkbox.dataset.fileId);

        if (ids.length === 0) {
            showResultMessage('请先选择要删除的文件', 'yellow');
            return;
        }

        try {
            const response = await fetch(`/media?file-id-list=${ids.join(',')}`, {
                method: 'DELETE',
                credentials: 'include',
            });

            const result = await response.json();
            if (response.ok) {
                showResultMessage(`成功删除 ${result.deleted_count} 个文件`, 'green');
                // 刷新页面以更新列表
                setTimeout(() => location.reload(), 1500);
            } else {
                showResultMessage(result.message || '删除失败', 'red');
            }
        } catch (error) {
            showResultMessage('网络请求失败: ' + error.message, 'red');
        }
    }

    function updateSelectionCount() {
        const selected = document.querySelectorAll('.file-checkbox:checked');
        const batchBtn = document.getElementById('batch-delete-btn');
        if (batchBtn) {
            batchBtn.textContent = `删除选中项 (${selected.length})`;
        }
    }

    function showResultMessage(text, colorClass) {
        const div = document.getElementById('result-message');
        if (div) {
            div.className = `${colorClass} bg-${colorClass}-100 border-${colorClass}-400 text-${colorClass}-700 px-4 py-2 rounded-lg`;
            div.textContent = text;
            div.classList.remove('hidden');
            setTimeout(() => div.classList.add('hidden'), 3000);
        }
    }

    // 文件类型过滤
    function filterMedia(type) {
        // 如果类型改变，跳转到对应的过滤页面
        window.location.href = `{{ url_for('media.media_v2') }}?type=${type}`;
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统更新管理</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- 自定义样式 -->
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        body {
            background-color: #f5f7f9;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .version-badge {
            font-size: 0.9rem;
            padding: 0.5em 0.8em;
        }

        .changelog-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--light-color);
            border-radius: 5px;
            padding: 15px;
        }

        .progress {
            height: 25px;
            border-radius: 5px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: var(--success-color);
        }

        .status-offline {
            background-color: var(--danger-color);
        }

        .status-updating {
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .card {
                margin-bottom: 20px;
            }

            .display-4 {
                font-size: 2rem;
            }
        }

        /* Markdown内容样式 */
        .changelog-content pre {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .changelog-content code {
            background-color: #f1f1f1;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }

        .changelog-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin-left: 0;
            color: #666;
        }

        .changelog-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .changelog-content table, .changelog-content th, .changelog-content td {
            border: 1px solid #ddd;
        }

        .changelog-content th, .changelog-content td {
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <header class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">
            <i class="bi bi-cloud-arrow-down-fill me-2"></i>系统更新管理
        </h1>
        <p class="lead text-muted">保持您的系统处于最新状态，获取最新功能和安全更新</p>
    </header>

    <div class="row">
        <!-- 当前版本信息卡片 -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-info-circle me-2"></i>当前版本信息</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold">版本号:</span>
                        <span class="badge bg-primary version-badge"
                              id="current-version">{{ config.current_version }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold">自动检查:</span>
                        <span class="badge bg-success version-badge">{{ config.auto_check_interval // 3600 }} 小时</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">更新备份:</span>
                        <span class="badge bg-{{ 'success' if config.backup_before_update else 'warning' }} version-badge">
                                {{ '启用' if config.backup_before_update else '禁用' }}
                            </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 更新操作卡片 -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-{{ 'success' if update_status.available else 'secondary' }} text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-{{ 'arrow-up-circle' if update_status.available else 'check-circle' }} me-2"></i>
                        {{ '有可用更新' if update_status.available else '已是最新版本' }}
                    </h5>
                </div>
                <div class="card-body">
                    <div id="update-status" class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">最新版本:</span>
                            <span class="badge bg-{{ 'success' if update_status.available else 'secondary' }} version-badge"
                                  id="latest-version">
                                    {{ update_status.latest_version if update_status.latest_version else '未知' }}
                                </span>
                        </div>

                        <div id="update-progress-section"
                             class="mt-3 {{ '' if update_status.is_updating else 'd-none' }}">
                            <p class="fw-bold mb-1">更新进度:</p>
                            <div class="progress mb-2">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: {{ update_status.progress }}%">
                                    {{ update_status.progress }}%
                                </div>
                            </div>
                            <p id="progress-message" class="text-muted small">{{ update_status.message }}</p>
                        </div>

                        <div id="status-indicator" class="mt-3">
                            <p class="mb-0">
                                <span class="status-indicator status-{{ 'updating' if update_status.is_updating else 'online' }}"></span>
                                <span id="status-text">{{ '更新进行中...' if update_status.is_updating else '系统正常' }}</span>
                            </p>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="check-update-btn" class="btn btn-outline-primary"
                                {% if update_status.is_updating %}disabled{% endif %}>
                            <i class="bi bi-arrow-repeat me-1"></i>检查更新
                        </button>
                        <button id="do-update-btn"
                                class="btn btn-success {{ '' if update_status.available and not update_status.is_updating and update_status.latest_version != config.current_version else 'd-none' }}"
                                {{ 'disabled' if not update_status.available or update_status.is_updating or update_status.latest_version == config.current_version else '' }}>
                            <i class="bi bi-download me-1"></i>立即更新
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 更新日志卡片 -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0"><i class="bi bi-journal-text me-2"></i>更新日志</h5>
                </div>
                <div class="card-body p-0">
                    <div class="changelog-container p-3">
                        <div id="changelog-content" class="changelog-content">
                            {% if update_status.changelog %}
                                {{ update_status.changelog|safe }}
                            {% else %}
                                <p class="text-center text-muted my-4">暂无更新日志</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i id="toast-icon" class="bi bi-info-circle text-primary me-2"></i>
                <strong id="toast-title" class="me-auto">通知</strong>
                <small>刚刚</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div id="toast-body" class="toast-body"></div>
        </div>
    </div>
</div>

<!-- Bootstrap & jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        // 初始化Toast
        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl, {delay: 3000});

        // 显示通知
        function showToast(title, message, type = 'info') {
            const iconClass = {
                'info': 'bi-info-circle text-primary',
                'success': 'bi-check-circle text-success',
                'warning': 'bi-exclamation-circle text-warning',
                'error': 'bi-x-circle text-danger'
            }[type];

            $('#toast-icon').attr('class', iconClass + ' me-2');
            $('#toast-title').text(title);
            $('#toast-body').text(message);
            toast.show();
        }

        // 检查更新按钮点击事件
        $('#check-update-btn').click(function () {
            $(this).prop('disabled', true);
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 检查中...');

            $.get('/check_update', function (data) {
                $('#check-update-btn').prop('disabled', false);
                $('#check-update-btn').html('<i class="bi bi-arrow-repeat me-1"></i>检查更新');

                if (data.status === 'update_available') {
                    $('#latest-version').text(data.latest_version);
                    $('#latest-version').removeClass('bg-secondary').addClass('bg-success');
                    $('#changelog-content').html(data.changelog);

                    // 显示更新按钮
                    $('#do-update-btn').removeClass('d-none');

                    showToast('检查完成', '发现新版本: ' + data.latest_version, 'success');
                } else {
                    showToast('检查完成', '当前已是最新版本', 'info');
                }
            }).fail(function () {
                $('#check-update-btn').prop('disabled', false);
                $('#check-update-btn').html('<i class="bi bi-arrow-repeat me-1"></i>检查更新');
                showToast('错误', '检查更新失败，请重试', 'error');
            });
        });

        // 执行更新按钮点击事件
        $('#do-update-btn').click(function () {
            if (!confirm('确定要开始更新吗？更新过程中请不要关闭页面。')) {
                return;
            }

            $(this).prop('disabled', true);
            $('#check-update-btn').prop('disabled', true);

            $.post('/do_update', function (data) {
                if (data.status === 'success') {
                    showToast('开始更新', '更新进程已启动，请勿关闭页面', 'info');

                    // 显示进度区域
                    $('#update-progress-section').removeClass('d-none');

                    // 更新状态指示器
                    $('#status-indicator .status-indicator').attr('class', 'status-indicator status-updating');
                    $('#status-text').text('更新进行中...');

                    // 开始轮询更新状态
                    const progressInterval = setInterval(function () {
                        $.get('/update_status', function (status) {
                            // 更新进度条
                            $('#progress-bar').css('width', status.progress + '%');
                            $('#progress-bar').text(status.progress + '%');
                            $('#progress-message').text(status.message);

                            // 检查更新是否完成
                            if (!status.is_updating) {
                                clearInterval(progressInterval);

                                if (status.message.includes('成功')) {
                                    showToast('更新完成', '系统已成功更新到最新版本', 'success');
                                    $('#status-indicator .status-indicator').attr('class', 'status-indicator status-online');
                                    $('#status-text').text('系统正常');

                                    // 更新当前版本显示
                                    $('#current-version').text($('#latest-version').text());

                                    // 隐藏更新按钮
                                    $('#do-update-btn').addClass('d-none');
                                } else {
                                    showToast('更新失败', status.message, 'error');
                                    $('#status-indicator .status-indicator').attr('class', 'status-indicator status-offline');
                                    $('#status-text').text('更新失败');

                                    // 重新启用按钮
                                    $('#check-update-btn').prop('disabled', false);
                                    $('#do-update-btn').prop('disabled', false);
                                }

                                // 隐藏进度区域
                                $('#update-progress-section').addClass('d-none');
                            }
                        });
                    }, 2000); // 每2秒检查一次状态
                } else {
                    showToast('错误', data.message, 'error');
                    $('#check-update-btn').prop('disabled', false);
                    $('#do-update-btn').prop('disabled', false);
                }
            }).fail(function () {
                showToast('错误', '请求失败，请重试', 'error');
                $('#check-update-btn').prop('disabled', false);
                $('#do-update-btn').prop('disabled', false);
            });
        });

        // 初始页面加载时，如果有更新可用，确保更新按钮可见
        {% if update_status.available and not update_status.is_updating %}
            $('#do-update-btn').removeClass('d-none');
        {% endif %}

        // 如果正在更新中，显示进度并开始轮询
        {% if update_status.is_updating %}
            $('#update-progress-section').removeClass('d-none');
            $('#progress-bar').css('width', '{{ update_status.progress }}%');
            $('#progress-bar').text('{{ update_status.progress }}%');
            $('#progress-message').text('{{ update_status.message }}');

            $('#check-update-btn').prop('disabled', true);
            $('#do-update-btn').prop('disabled', true);

            // 开始轮询更新状态
            const progressInterval = setInterval(function () {
                $.get('/update_status', function (status) {
                    // 更新进度条
                    $('#progress-bar').css('width', status.progress + '%');
                    $('#progress-bar').text(status.progress + '%');
                    $('#progress-message').text(status.message);

                    // 检查更新是否完成
                    if (!status.is_updating) {
                        clearInterval(progressInterval);

                        if (status.message.includes('成功')) {
                            showToast('更新完成', '系统已成功更新到最新版本', 'success');
                            $('#status-indicator .status-indicator').attr('class', 'status-indicator status-online');
                            $('#status-text').text('系统正常');

                            // 更新当前版本显示
                            $('#current-version').text($('#latest-version').text());

                            // 隐藏更新按钮
                            $('#do-update-btn').addClass('d-none');
                        } else {
                            showToast('更新失败', status.message, 'error');
                            $('#status-indicator .status-indicator').attr('class', 'status-indicator status-offline');
                            $('#status-text').text('更新失败');
                        }

                        // 重新启用检查按钮
                        $('#check-update-btn').prop('disabled', false);

                        // 隐藏进度区域
                        $('#update-progress-section').addClass('d-none');
                    }
                });
            }, 2000); // 每2秒检查一次状态
        {% endif %}
    });
</script>
</body>
</html>
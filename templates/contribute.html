<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contribute Translation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#6366F1',
                        dark: '#1F2937',
                        light: '#F9FAFB'
                    }
                }
            }
        }
    </script>
    <style>
        .markdown-toolbar {
            border-bottom: 1px solid #E5E7EB;
            padding: 0.5rem;
            background-color: #F9FAFB;
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
        }

        .markdown-toolbar button {
            padding: 0.25rem 0.5rem;
            margin-right: 0.5rem;
            border-radius: 0.25rem;
            background: white;
            border: 1px solid #D1D5DB;
        }

        .markdown-toolbar button:hover {
            background: #EFF6FF;
        }

        .markdown-editor {
            min-height: 300px;
            border: 1px solid #E5E7EB;
            border-top: none;
            padding: 1rem;
            width: 100%;
            font-family: monospace;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }

        .markdown-preview {
            border: 1px solid #E5E7EB;
            border-radius: 0.375rem;
            padding: 1rem;
            min-height: 300px;
            background: white;
        }

        #slugPreview {
            background-color: #F3F4F6;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- Header -->
    <header class="bg-white shadow-sm rounded-lg p-6 mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Contribute Translation</h1>
        <p class="text-gray-600 mt-2">Help translate this article to make it accessible to more readers worldwide</p>
    </header>

    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <!-- Progress Bar -->
        <div class="bg-gray-200 h-2 w-full">
            <div class="bg-primary h-2 transition-all duration-300" id="progressBar" style="width: 33%"></div>
        </div>

        <!-- Form Steps -->
        <form id="contributionForm" class="p-6">
            <input type="hidden" name="aid" value="{{ aid }}">

            <!-- Step 1: Language Selection -->
            <div id="step1" class="step active">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">1. Select Language</h2>
                <p class="text-gray-600 mb-6">Choose the language you want to translate this article into.</p>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="contribute_language">
                        Language *
                    </label>
                    <select name="contribute_language" id="contribute_language" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">Select a language</option>
                        {% for code in valid_language_codes %}
                            <option value="{{ code }}">{{ code }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="existingTranslations"
                     class="bg-blue-50 p-4 rounded-md mb-6 {% if not existing_languages %}hidden{% endif %}">
                    <h3 class="font-medium text-blue-800">Existing Translations</h3>
                    <p class="text-blue-600 text-sm mt-1">This article already has translations in these languages:</p>
                    <div id="existingLanguages" class="flex flex-wrap gap-2 mt-2">
                        {% for lang in existing_languages %}
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">{{ lang }}</span>
                        {% endfor %}
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="button" onclick="showStep(2)"
                            class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary transition">
                        Next <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Content Translation -->
            <div id="step2" class="step">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Translate Content</h2>
                <p class="text-gray-600 mb-6">Translate the article title and content below.</p>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="contribute_title">
                        Article Title *
                    </label>
                    <input type="text" name="contribute_title" id="contribute_title" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="Translated article title">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="contribute_slug">
                        URL Slug *
                    </label>
                    <input type="text" name="contribute_slug" id="contribute_slug" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="translated-article-title">
                    <p class="text-gray-500 text-xs mt-1">This will be used in the article URL. Only letters, numbers,
                        and hyphens are allowed.</p>
                    <div class="mt-2">
                        <span class="text-gray-700 text-sm">Preview: </span>
                        <span id="slugPreview" class="text-sm">your-slug-will-appear-here</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        Article Content *
                    </label>
                    <div class="markdown-toolbar">
                        <button type="button" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                        <button type="button" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                        <button type="button" onclick="formatText('heading')"><i class="fas fa-heading"></i></button>
                        <button type="button" onclick="formatText('link')"><i class="fas fa-link"></i></button>
                        <button type="button" onclick="formatText('quote')"><i class="fas fa-quote-right"></i></button>
                        <button type="button" onclick="formatText('code')"><i class="fas fa-code"></i></button>
                        <button type="button" onclick="formatText('image')"><i class="fas fa-image"></i></button>
                        <button type="button" onclick="formatText('unordered-list')"><i class="fas fa-list-ul"></i>
                        </button>
                        <button type="button" onclick="formatText('ordered-list')"><i class="fas fa-list-ol"></i>
                        </button>
                    </div>
                    <textarea name="contribute_content" id="contribute_content" required
                              class="markdown-editor"
                              placeholder="Write your translation in Markdown format"></textarea>
                </div>

                <div class="flex justify-between">
                    <button type="button" onclick="showStep(1)"
                            class="text-gray-600 px-4 py-2 rounded-md hover:bg-gray-100 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    <button type="button" onclick="showStep(3)"
                            class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary transition">
                        Next <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Review & Submit -->
            <div id="step3" class="step">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">3. Review & Submit</h2>
                <p class="text-gray-600 mb-6">Review your translation before submitting.</p>

                <div class="bg-gray-50 p-4 rounded-md mb-6">
                    <h3 class="font-medium text-gray-800">Translation Details</h3>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Language</p>
                            <p id="reviewLanguage" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Title</p>
                            <p id="reviewTitle" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">URL Slug</p>
                            <p id="reviewSlug" class="font-medium"></p>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        Content Preview
                    </label>
                    <div id="contentPreview" class="markdown-preview prose max-w-none">
                        Your content will be previewed here...
                    </div>
                </div>

                <div class="flex justify-between">
                    <button type="button" onclick="showStep(2)"
                            class="text-gray-600 px-4 py-2 rounded-md hover:bg-gray-100 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    <button type="button" id="submitButton"
                            class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
                        <i class="fas fa-paper-plane mr-2"></i> Submit Translation
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Success!</h3>
                <p class="text-gray-600 mb-4" id="successMessage">Your translation has been submitted successfully.</p>
                <button onclick="closeModal()"
                        class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary transition">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Error!</h3>
                <p class="text-gray-600 mb-4" id="errorMessage">An error occurred while submitting your translation.</p>
                <button onclick="closeErrorModal()"
                        class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary transition">
                    Try Again
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Show existing translations if any
    document.addEventListener('DOMContentLoaded', function () {
        const existingLanguages = document.getElementById('existingLanguages');
        if (existingLanguages && existingLanguages.children.length > 0) {
            document.getElementById('existingTranslations').classList.remove('hidden');
        }

        // Slug preview
        document.getElementById('contribute_slug').addEventListener('input', updateSlugPreview);

        // Submit button event listener
        document.getElementById('submitButton').addEventListener('click', submitForm);
    });

    let currentStep = 1;

    function showStep(step) {
        // Validate current step before proceeding
        if (step > currentStep) {
            if (!validateStep(currentStep)) {
                return;
            }
        }

        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
        currentStep = step;

        // Update progress bar
        const progress = (step / 3) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;

        // If moving to review step, update review content
        if (step === 3) {
            updateReview();
        }
    }

    function validateStep(step) {
        if (step === 1) {
            const language = document.getElementById('contribute_language');
            if (!language.value) {
                showError('Please select a language');
                language.focus();
                return false;
            }
        } else if (step === 2) {
            const title = document.getElementById('contribute_title');
            const slug = document.getElementById('contribute_slug');
            const content = document.getElementById('contribute_content');

            if (!title.value) {
                showError('Please enter a title');
                title.focus();
                return false;
            }

            if (!slug.value) {
                showError('Please enter a URL slug');
                slug.focus();
                return false;
            }

            if (!content.value) {
                showError('Please enter content');
                content.focus();
                return false;
            }
        }
        return true;
    }

    function updateSlugPreview() {
        const language = document.getElementById('contribute_language');
        const slugInput = document.getElementById('contribute_slug');
        const slugPreview = document.getElementById('slugPreview');

        // Clean the slug
        let cleanSlug = slugInput.value
            .toLowerCase()
            .replace(/[^\w\s]/gi, '')
            .replace(/\s+/g, '-');

        slugPreview.textContent = `/{{ aid }}.html/${language.value}/` + cleanSlug || 'your-slug-will-appear-here';
    }

    function updateReview() {
        document.getElementById('reviewLanguage').textContent =
            document.getElementById('contribute_language').value;
        document.getElementById('reviewTitle').textContent =
            document.getElementById('contribute_title').value;
        document.getElementById('reviewSlug').textContent =
            document.getElementById('contribute_slug').value;

        // Simple markdown preview (in a real app, use a proper markdown parser)
        const content = document.getElementById('contribute_content').value;
        document.getElementById('contentPreview').innerHTML =
            content.replace(/\n/g, '<br>');
    }

    function formatText(type) {
        const textarea = document.getElementById('contribute_content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        let replacement = '';

        switch (type) {
            case 'bold':
                replacement = `**${selectedText}**`;
                break;
            case 'italic':
                replacement = `*${selectedText}*`;
                break;
            case 'heading':
                replacement = `# ${selectedText}`;
                break;
            case 'link':
                replacement = `[${selectedText}](url)`;
                break;
            case 'quote':
                replacement = `> ${selectedText}`;
                break;
            case 'code':
                replacement = "```\n" + selectedText + "\n```";
                break;
            case 'image':
                replacement = `![alt text](${selectedText})`;
                break;
            case 'unordered-list':
                replacement = selectedText.split('\n').map(line => `- ${line}`).join('\n');
                break;
            case 'ordered-list':
                replacement = selectedText.split('\n').map((line, i) => `${i + 1}. ${line}`).join('\n');
                break;
        }

        textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
        textarea.focus();
    }

    function submitForm() {
        if (!validateStep(3)) return;

        const formData = {
            contribute_type: 'translation',
            contribute_language: document.getElementById('contribute_language').value,
            contribute_title: document.getElementById('contribute_title').value,
            contribute_slug: document.getElementById('contribute_slug').value,
            contribute_content: document.getElementById('contribute_content').value
        };

        // Show loading state
        const submitBtn = document.getElementById('submitButton');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';
        submitBtn.disabled = true;

        fetch('/contribute?aid={{ aid }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'Server error');
                    }).catch(() => {
                        throw new Error(`Server error: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    document.getElementById('successMessage').textContent = data.message;
                    document.getElementById('successModal').classList.remove('hidden');
                } else {
                    throw new Error(data.message || 'Submission failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorModal').classList.remove('hidden');
            })
            .finally(() => {
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Submit Translation';
                submitBtn.disabled = false;
            });
    }

    function closeModal() {
        document.getElementById('successModal').classList.add('hidden');
        // Redirect or reset form as needed
        window.location.href = '/'; // Redirect to home page
    }

    function closeErrorModal() {
        document.getElementById('errorModal').classList.add('hidden');
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorModal').classList.remove('hidden');
    }
</script>
</body>
</html>
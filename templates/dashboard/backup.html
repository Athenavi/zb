{% extends "dashboard/base.html" %}

{% block title %}管理后台 - 备份管理{% endblock %}
{% block page_title %}备份管理{% endblock %}

{% block extra_css %}
    <style>
        .backup-card {
            transition: all 0.2s ease;
        }

        .backup-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .file-size {
            color: #64748b;
            font-size: 0.875rem;
        }

        .backup-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .action-btn {
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }
    </style>
{% endblock %}

{% block content %}
    <!-- 备份操作卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- 备份结构 -->
        <div class="backup-card bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
            <div class="flex items-center mb-4">
                <div class="p-3 rounded-lg bg-blue-100 text-blue-600 mr-4">
                    <i class="fas fa-database text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">备份数据库结构</h3>
                    <p class="text-sm text-gray-600">仅备份表结构，不包含数据</p>
                </div>
            </div>
            <button class="w-full backup-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    data-type="schema">
                <i class="fas fa-download mr-2"></i>备份结构
            </button>
        </div>

        <!-- 备份数据 -->
        <div class="backup-card bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
            <div class="flex items-center mb-4">
                <div class="p-3 rounded-lg bg-green-100 text-green-600 mr-4">
                    <i class="fas fa-table text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">备份数据库数据</h3>
                    <p class="text-sm text-gray-600">仅备份表数据，不包含结构</p>
                </div>
            </div>
            <button class="w-full backup-btn px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                    data-type="data">
                <i class="fas fa-download mr-2"></i>备份数据
            </button>
        </div>

        <!-- 完整备份 -->
        <div class="backup-card bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
            <div class="flex items-center mb-4">
                <div class="p-3 rounded-lg bg-purple-100 text-purple-600 mr-4">
                    <i class="fas fa-archive text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">完整备份</h3>
                    <p class="text-sm text-gray-600">备份数据库结构和数据</p>
                </div>
            </div>
            <button class="w-full backup-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                    data-type="all">
                <i class="fas fa-file-archive mr-2"></i>完整备份
            </button>
        </div>
    </div>

    <!-- 备份文件列表 -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <!-- 表格头部 -->
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-800">备份文件列表</h2>
            <div class="text-sm text-gray-500">
                共 <span class="font-semibold text-blue-600">{{ backup_list|length }}</span> 个备份文件
            </div>
        </div>

        <div class="p-6">
            {% if backup_list %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                文件名
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                类型
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                大小
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                创建时间
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                操作
                            </th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        {% for backup in backup_list %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10 rounded-full
                                {% if backup.type == 'schema' %}bg-blue-100 text-blue-600
                                {% elif backup.type == 'data' %}bg-green-100 text-green-600
                                {% elif backup.type == 'all' %}bg-purple-100 text-purple-600
                                {% else %}bg-gray-100 text-gray-600{% endif %}
                                flex items-center justify-center">
                                            <i class="fas
                                    {% if backup.type == 'schema' %}fa-database
                                    {% elif backup.type == 'data' %}fa-table
                                    {% elif backup.type == 'all' %}fa-archive
                                    {% else %}fa-file{% endif %} text-sm">
                                            </i>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">{{ backup.name }}</div>
                                            {% if backup.name.endswith('.gz') %}
                                                <span class="text-xs text-gray-500">压缩文件</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if backup.type == 'schema' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 backup-type-badge">
                                        结构备份
                                    </span>
                                    {% elif backup.type == 'data' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 backup-type-badge">
                                        数据备份
                                    </span>
                                    {% elif backup.type == 'all' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 backup-type-badge">
                                        完整备份
                                    </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 backup-type-badge">
                                        未知类型
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {% if backup.size < 1024 %}
                                        {{ backup.size }} B
                                    {% elif backup.size < 1048576 %}
                                        {{ (backup.size / 1024) | round(1) }} KB
                                    {% else %}
                                        {{ (backup.size / 1048576) | round(1) }} MB
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ backup.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-3">
                                        <a href="{{ url_for('admin.download_backup', filename=backup.name) }}"
                                           class="action-btn text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50"
                                           title="下载">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button class="action-btn text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 delete-backup"
                                                data-filename="{{ backup.name }}" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-12">
                    <div class="text-gray-400 mb-4">
                        <i class="fas fa-archive text-5xl"></i>
                    </div>
                    <p class="text-gray-500 text-lg">暂无备份文件</p>
                    <p class="text-sm text-gray-400 mt-2">点击上方的备份按钮创建第一个备份</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 备份进度模态框 -->
    <div id="backupModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                    <i class="fas fa-cog fa-spin text-blue-600"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="backupModalTitle">正在备份</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="backupModalMessage">
                        正在准备备份，请稍候...
                    </p>
                    <div class="mt-4 w-full bg-gray-200 rounded-full h-2">
                        <div id="backupProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                             style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div id="deleteConfirmModal"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">确认删除</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="deleteConfirmMessage">
                        您确定要删除此备份文件吗？
                    </p>
                    <div class="flex justify-center space-x-4 mt-6">
                        <button id="confirmDeleteBtn"
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            确认删除
                        </button>
                        <button id="cancelDeleteBtn"
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 显示消息函数
        function showMessage(message, type = 'info') {
            // 这里可以集成您项目中已有的消息提示组件
            alert(`${type.toUpperCase()}: ${message}`);
        }

        // 备份功能
        document.querySelectorAll('.backup-btn').forEach(button => {
            button.addEventListener('click', function () {
                const backupType = this.getAttribute('data-type');
                let title = '';
                let message = '';

                switch (backupType) {
                    case 'schema':
                        title = '备份数据库结构';
                        message = '正在备份数据库表结构...';
                        break;
                    case 'data':
                        title = '备份数据库数据';
                        message = '正在备份数据库表数据...';
                        break;
                    case 'all':
                        title = '完整数据库备份';
                        message = '正在备份数据库结构和数据...';
                        break;
                }

                // 显示备份模态框
                document.getElementById('backupModalTitle').textContent = title;
                document.getElementById('backupModalMessage').textContent = message;
                document.getElementById('backupModal').classList.remove('hidden');

                // 模拟进度条
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 10;
                    if (progress > 90) progress = 90;
                    document.getElementById('backupProgress').style.width = `${progress}%`;
                }, 200);

                // 发送备份请求
                const formData = new FormData();
                formData.append('backup_type', backupType);

                fetch('{{ url_for("admin.backup") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        clearInterval(progressInterval);
                        document.getElementById('backupProgress').style.width = '100%';

                        setTimeout(() => {
                            document.getElementById('backupModal').classList.add('hidden');

                            if (data.success) {
                                showMessage(data.message, 'success');
                                location.reload();
                            } else {
                                showMessage('备份失败: ' + data.message, 'error');
                            }
                        }, 500);
                    })
                    .catch(error => {
                        clearInterval(progressInterval);
                        document.getElementById('backupModal').classList.add('hidden');
                        console.error('Error:', error);
                        showMessage('备份失败，请检查网络连接', 'error');
                    });
            });
        });

        // 删除备份功能
        let currentDeleteFilename = '';

        document.querySelectorAll('.delete-backup').forEach(button => {
            button.addEventListener('click', function () {
                currentDeleteFilename = this.getAttribute('data-filename');
                document.getElementById('deleteConfirmMessage').textContent =
                    `您确定要删除备份文件 "${currentDeleteFilename}" 吗？此操作不可撤销。`;
                document.getElementById('deleteConfirmModal').classList.remove('hidden');
            });
        });

        // 确认删除按钮
        document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
            const formData = new FormData();
            formData.append('backup_type', 'delete');
            formData.append('filename', currentDeleteFilename);

            fetch('{{ url_for("admin.backup") }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('deleteConfirmModal').classList.add('hidden');
                    if (data.success) {
                        showMessage(data.message, 'success');
                        location.reload();
                    } else {
                        showMessage('删除失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    document.getElementById('deleteConfirmModal').classList.add('hidden');
                    console.error('Error:', error);
                    showMessage('删除失败', 'error');
                });
        });

        // 取消删除按钮
        document.getElementById('cancelDeleteBtn').addEventListener('click', function () {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            currentDeleteFilename = '';
        });
    </script>
{% endblock %}
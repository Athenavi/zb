{% extends "base.html" %}
{% block title %}{{ _('Register - Authentication System') }}{% endblock %}

{% block content %}
    {% from "macros/_i18n.html" import language_selector %}
    <div class="absolute top-4 right-4">
        {{ language_selector() }}
    </div>
    <div class="flex min-h-full flex-col justify-center py-12 sm:px-6 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-md">
            <div class="flex justify-center">
                <div class="w-12 h-12 bg-primary-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-user-plus text-white text-xl"></i>
                </div>
            </div>
            <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-gray-900">
                {{ _('Create new account') }}
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                已有账户？
                <a href="{{ url_for('auth.login') }}" class="font-medium text-primary-600 hover:text-primary-500">
                    {{ _('Sign in now') }}
                </a>
            </p>
        </div>

        <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
            <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
                <!-- Registration Progress -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium text-primary-600">{{ _('Registration progress') }}</span>
                        <span class="text-xs font-medium text-primary-600" id="progress-text">1/4</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-primary-600 h-2 rounded-full transition-all duration-300" id="progress-bar"
                             style="width: 25%"></div>
                    </div>
                </div>

                <form id="registration-form" class="space-y-6" method="POST" action="{{ url_for('auth.register') }}">
                    {{ form.hidden_tag() }}

                    <!-- Step 1: Basic Information -->
                    <div id="step-1" class="registration-step">
                        <div class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700">
                                    {{ _('Username') }} <span class="text-red-500">*</span>
                                </label>
                                <div class="mt-1 relative">
                                    {{ form.username(class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm", placeholder="请输入用户名（3-20个字符）") }}
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                        <i class="fas fa-user text-gray-400"></i>
                                    </div>
                                </div>
                                <div id="username-feedback" class="mt-1 text-xs hidden"></div>
                            </div>

                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">
                                    {{ _('Email address') }} <span class="text-red-500">*</span>
                                </label>
                                <div class="mt-1 relative">
                                    {{ form.email(class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm", placeholder="请输入邮箱地址") }}
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                        <i class="fas fa-envelope text-gray-400"></i>
                                    </div>
                                </div>
                                <div id="email-feedback" class="mt-1 text-xs hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Password Setup -->
                    <div id="step-2" class="registration-step hidden">
                        <div class="space-y-4">
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">
                                    {{ _('Password') }} <span class="text-red-500">*</span>
                                </label>
                                <div class="mt-1 relative">
                                    {{ form.password(class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm", placeholder="请输入密码（至少8个字符）") }}
                                    <button type="button" id="toggle-password"
                                            class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                        <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                                    </button>
                                </div>

                                <!-- Password Strength Indicator -->
                                <div class="mt-2">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs text-gray-600">{{ _('Password strength') }}</span>
                                        <span id="strength-text" class="text-xs font-medium"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1">
                                        <div id="strength-bar"
                                             class="h-1 rounded-full transition-all duration-300 bg-gray-300"
                                             style="width: 0%"></div>
                                    </div>
                                    <div id="password-requirements" class="mt-2 space-y-1">
                                        <div class="flex items-center text-xs">
                                            <i id="req-length" class="fas fa-times text-red-500 w-4"></i>
                                            <span class="ml-2 text-gray-600">{{ _('At least 8 characters') }}</span>
                                        </div>
                                        <div class="flex items-center text-xs">
                                            <i id="req-uppercase" class="fas fa-times text-red-500 w-4"></i>
                                            <span class="ml-2 text-gray-600">{{ _('Contains uppercase letter') }}</span>
                                        </div>
                                        <div class="flex items-center text-xs">
                                            <i id="req-lowercase" class="fas fa-times text-red-500 w-4"></i>
                                            <span class="ml-2 text-gray-600">{{ _('Contains lowercase letter') }}</span>
                                        </div>
                                        <div class="flex items-center text-xs">
                                            <i id="req-number" class="fas fa-times text-red-500 w-4"></i>
                                            <span class="ml-2 text-gray-600">{{ _('Contains number') }}</span>
                                        </div>
                                        <div class="flex items-center text-xs">
                                            <i id="req-special" class="fas fa-times text-red-500 w-4"></i>
                                            <span class="ml-2 text-gray-600">{{ _('Contains special character') }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="confirm_password" class="block text-sm font-medium text-gray-700">
                                    {{ _('Confirm password') }} <span class="text-red-500">*</span>
                                </label>
                                <div class="mt-1 relative">
                                    {{ form.confirm_password(class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm", placeholder="请再次输入密码") }}
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                        <i id="confirm-icon" class="fas fa-lock text-gray-400"></i>
                                    </div>
                                </div>
                                <div id="confirm-feedback" class="mt-1 text-xs hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Personal Information -->
                    <div id="step-3" class="registration-step hidden">
                        <div class="space-y-4">
                            <div>
                                <label for="display_name" class="block text-sm font-medium text-gray-700">
                                    {{ _('Display name') }}
                                </label>
                                <div class="mt-1">
                                    {{ form.display_name(class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm", placeholder="请输入显示名称（可选）") }}
                                </div>
                            </div>

                            <div>
                                <label for="bio" class="block text-sm font-medium text-gray-700">
                                    {{ _('Bio') }}
                                </label>
                                <div class="mt-1">
                                    {{ form.bio(rows=3, class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm", placeholder="简单介绍一下自己...") }}
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="location" class="block text-sm font-medium text-gray-700">
                                        {{ _('Location') }}
                                    </label>
                                    <div class="mt-1">
                                        {{ form.location(class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm", placeholder="例如：北京") }}
                                    </div>
                                </div>

                                <div>
                                    <label for="website" class="block text-sm font-medium text-gray-700">
                                        {{ _('Website') }}
                                    </label>
                                    <div class="mt-1">
                                        {{ form.website(class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm", placeholder="https://") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Preferences & Terms -->
                    <div id="step-4" class="registration-step hidden">
                        <div class="space-y-4">
                            <div>
                                <label for="locale" class="block text-sm font-medium text-gray-700">
                                    {{ _('Language preference') }}
                                </label>
                                <div class="mt-1">
                                    {{ form.locale(class="block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-primary-500 sm:text-sm") }}
                                </div>
                            </div>

                            <div class="space-y-3">
                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        {{ form.profile_private(class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500") }}
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="profile_private" class="text-gray-700">
                                            {{ _('Private profile (others cannot view your personal information)') }}
                                        </label>
                                    </div>
                                </div>

                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        {{ form.newsletter(class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500") }}
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="newsletter" class="text-gray-700">
                                            {{ _('Subscribe to newsletter for updates') }}
                                        </label>
                                    </div>
                                </div>

                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        {{ form.marketing_emails(class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500") }}
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="marketing_emails" class="text-gray-700">
                                            {{ _('Receive product recommendations and marketing emails') }}
                                        </label>
                                    </div>
                                </div>

                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        {{ form.terms(class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500") }}
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="terms" class="text-gray-700">
                                            {{ _('I have read and agree to') }}
                                            <a href="#"
                                               class="font-medium text-primary-600 hover:text-primary-500">服务条款</a>
                                            {{ _('and') }}
                                            <a href="#"
                                               class="font-medium text-primary-600 hover:text-primary-500">隐私政策</a>
                                            <span class="text-red-500">*</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between pt-4">
                        <button type="button" id="prev-btn"
                                class="hidden px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                            <i class="fas fa-arrow-left mr-2"></i>{{ _('Previous') }}
                        </button>

                        <div class="flex-1"></div>

                        <button type="button" id="next-btn"
                                class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                            {{ _('Next') }}<i class="fas fa-arrow-right ml-2"></i>
                        </button>

                        <button type="submit" id="submit-btn"
                                class="hidden px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                            <i class="fas fa-user-plus mr-2"></i>{{ _('Create account') }}
                        </button>
                    </div>
                </form>

                <!-- Social Registration -->
                <div class="mt-6">
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="bg-white px-2 text-gray-500">{{ _('Or use') }}</span>
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-2 gap-3">
                        <button class="inline-flex w-full justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-500 shadow-sm hover:bg-gray-50 transition-colors duration-200">
                            <i class="fab fa-google text-red-500"></i>
                            <span class="ml-2">Google</span>
                        </button>
                        <button class="inline-flex w-full justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-500 shadow-sm hover:bg-gray-50 transition-colors duration-200">
                            <i class="fab fa-github text-gray-800"></i>
                            <span class="ml-2">GitHub</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let currentStep = 1;
            const totalSteps = 4;

            const steps = document.querySelectorAll('.registration-step');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            // Form inputs
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirm_password');
            const togglePassword = document.getElementById('toggle-password');
            const termsCheckbox = document.getElementById('terms');

            // Navigation
            nextBtn.addEventListener('click', function () {
                if (validateCurrentStep()) {
                    if (currentStep < totalSteps) {
                        currentStep++;
                        updateStep();
                    }
                }
            });

            prevBtn.addEventListener('click', function () {
                if (currentStep > 1) {
                    currentStep--;
                    updateStep();
                }
            });

            function updateStep() {
                // Hide all steps
                steps.forEach(step => step.classList.add('hidden'));

                // Show current step
                const currentStepElement = document.getElementById(`step-${currentStep}`);
                if (currentStepElement) {
                    currentStepElement.classList.remove('hidden');
                }

                // Update progress
                const progress = (currentStep / totalSteps) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = `${currentStep}/${totalSteps}`;

                // Update buttons
                prevBtn.classList.toggle('hidden', currentStep === 1);
                nextBtn.classList.toggle('hidden', currentStep === totalSteps);
                submitBtn.classList.toggle('hidden', currentStep !== totalSteps);
            }

            function validateCurrentStep() {
                let isValid = true;

                switch (currentStep) {
                    case 1:
                        isValid = validateBasicInfo();
                        break;
                    case 2:
                        isValid = validatePassword();
                        break;
                    case 3:
                        // Personal info is optional, no validation needed
                        isValid = true;
                        break;
                    case 4:
                        isValid = validateTerms();
                        break;
                    default:
                        isValid = true;
                }

                return isValid;
            }

            function validateBasicInfo() {
                const username = usernameInput.value.trim();
                const email = emailInput.value.trim();
                let isValid = true;

                // Reset feedback
                showFeedback('username-feedback', '', 'success');
                showFeedback('email-feedback', '', 'success');

                // Username validation
                if (username.length < 3 || username.length > 20) {
                    showFeedback('username-feedback', '用户名必须在3-20个字符之间', 'error');
                    isValid = false;
                } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                    showFeedback('username-feedback', '用户名只能包含字母、数字和下划线', 'error');
                    isValid = false;
                } else {
                    // Check username availability
                    checkFieldAvailability('username', username, 'username-feedback', function (available) {
                        if (!available) {
                            showFeedback('username-feedback', '用户名已被使用', 'error');
                        }
                    });
                }

                // Email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showFeedback('email-feedback', '请输入有效的邮箱地址', 'error');
                    isValid = false;
                } else {
                    // Check email availability
                    checkFieldAvailability('email', email, 'email-feedback', function (available) {
                        if (!available) {
                            showFeedback('email-feedback', '邮箱已被使用', 'error');
                        }
                    });
                }

                return isValid;
            }

            function validatePassword() {
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                let isValid = true;

                // Reset feedback
                showFeedback('confirm-feedback', '', 'success');

                // Password strength validation
                if (!isPasswordStrong(password)) {
                    isValid = false;
                }

                // Password confirmation
                if (password !== confirmPassword) {
                    showFeedback('confirm-feedback', '两次输入的密码不一致', 'error');
                    document.getElementById('confirm-icon').className = 'fas fa-times text-red-500';
                    isValid = false;
                } else if (confirmPassword) {
                    showFeedback('confirm-feedback', '密码确认正确', 'success');
                    document.getElementById('confirm-icon').className = 'fas fa-check text-green-500';
                }

                return isValid;
            }

            function validateTerms() {
                if (!termsCheckbox.checked) {
                    alert('请阅读并同意服务条款和隐私政策');
                    return false;
                }
                return true;
            }

            function checkFieldAvailability(field, value, feedbackId, callback) {
                fetch(`/api/check-${field}?${field}=${encodeURIComponent(value)}`)
                    .then(response => response.json())
                    .then(data => {
                        callback(!data.exists);
                    })
                    .catch(error => {
                        console.error('Error checking field:', error);
                        showFeedback(feedbackId, '检查时发生错误', 'error');
                    });
            }

            function showFeedback(elementId, message, type) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.className = `mt-1 text-xs ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
                    if (message) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                }
            }

            // Password toggle
            togglePassword.addEventListener('click', function () {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);

                const icon = this.querySelector('i');
                if (type === 'password') {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                } else {
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                }
            });

            // Password strength checker
            passwordInput.addEventListener('input', function () {
                checkPasswordStrength(this.value);
            });

            function checkPasswordStrength(password) {
                const requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /\d/.test(password),
                    special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\?]/.test(password)
                };

                // Update requirement indicators
                Object.keys(requirements).forEach(req => {
                    const element = document.getElementById(`req-${req}`);
                    if (element) {
                        if (requirements[req]) {
                            element.className = 'fas fa-check text-green-500 w-4';
                        } else {
                            element.className = 'fas fa-times text-red-500 w-4';
                        }
                    }
                });

                // Calculate strength
                const score = Object.values(requirements).filter(Boolean).length;
                const strengthBar = document.getElementById('strength-bar');
                const strengthText = document.getElementById('strength-text');

                if (!strengthBar || !strengthText) return;

                if (score === 0) {
                    strengthBar.style.width = '0%';
                    strengthBar.className = 'h-1 rounded-full transition-all duration-300 bg-gray-300';
                    strengthText.textContent = '';
                } else if (score <= 2) {
                    strengthBar.style.width = '25%';
                    strengthBar.className = 'h-1 rounded-full transition-all duration-300 bg-red-500';
                    strengthText.textContent = '弱';
                    strengthText.className = 'text-xs font-medium text-red-600';
                } else if (score <= 3) {
                    strengthBar.style.width = '50%';
                    strengthBar.className = 'h-1 rounded-full transition-all duration-300 bg-yellow-500';
                    strengthText.textContent = '中等';
                    strengthText.className = 'text-xs font-medium text-yellow-600';
                } else if (score <= 4) {
                    strengthBar.style.width = '75%';
                    strengthBar.className = 'h-1 rounded-full transition-all duration-300 bg-blue-500';
                    strengthText.textContent = '强';
                    strengthText.className = 'text-xs font-medium text-blue-600';
                } else {
                    strengthBar.style.width = '100%';
                    strengthBar.className = 'h-1 rounded-full transition-all duration-300 bg-green-500';
                    strengthText.textContent = '很强';
                    strengthText.className = 'text-xs font-medium text-green-600';
                }
            }

            function isPasswordStrong(password) {
                const requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /\d/.test(password),
                    special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\?]/.test(password)
                };
                return Object.values(requirements).every(Boolean);
            }

            // Real-time validation
            usernameInput.addEventListener('blur', function () {
                if (currentStep === 1) validateBasicInfo();
            });

            emailInput.addEventListener('blur', function () {
                if (currentStep === 1) validateBasicInfo();
            });

            confirmPasswordInput.addEventListener('input', function () {
                if (currentStep === 2) validatePassword();
            });

            // Initialize the form
            updateStep();
        });
    </script>
{% endblock %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin Manager - Flask Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .plugin-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .plugin-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .route-badge {
            font-family: monospace;
            font-size: 0.75rem;
        }

        .toggle-checkbox:checked {
            background-color: #0ea5e9;
        }

        .toggle-checkbox:checked + .toggle-label {
            background-color: #0ea5e9;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
{% from 'header.html' import SimpleHeader %}
{{ SimpleHeader(title) }}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Plugin Manager</h1>
        <button id="install-plugin-btn"
                class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-md flex items-center">
            <i class="fas fa-plus-circle mr-2"></i> Install Plugin
        </button>
    </div>

    <!-- 插件卡片网格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for plugin in plugins %}
            <div class="plugin-card bg-white rounded-lg overflow-hidden border border-gray-200">
                <div class="p-5">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center">
                                <h3 class="text-lg font-semibold text-gray-900">{{ plugin.name }}</h3>
                                {% if plugin.enabled %}
                                    <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800 rounded-full">Active</span>
                                {% else %}
                                    <span class="ml-2 px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Inactive</span>
                                {% endif %}
                            </div>
                            <p class="mt-1 text-sm text-gray-500">v{{ plugin.version }} by {{ plugin.author }}</p>
                        </div>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none">
                            <input type="checkbox" name="toggle" id="toggle-{{ loop.index }}"
                                   class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                   {% if plugin.enabled %}checked{% endif %}
                                   data-plugin="{{ plugin.name }}">
                            <label for="toggle-{{ loop.index }}"
                                   class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <p class="mt-3 text-gray-600 text-sm">{{ plugin.description }}</p>

                    <div class="mt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Registered Routes</h4>
                        <div class="space-y-1">
                            {% for route in plugin.routes %}
                                <div class="flex items-center">
                                <span class="route-badge bg-gray-100 text-gray-800 px-2 py-1 rounded mr-2">
                                    {{ route.methods|join(',') }}
                                </span>
                                    <span class="text-gray-600 text-sm">{{ route.url }}</span>
                                </div>
                            {% else %}
                                <p class="text-gray-500 text-sm">No routes registered</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mt-6 flex justify-between">
                        <button class="text-primary-500 hover:text-primary-700 text-sm font-medium flex items-center">
                            <i class="fas fa-cog mr-1"></i> Configure
                        </button>
                        <button class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center delete-plugin"
                                data-plugin="{{ plugin.name }}">
                            <i class="fas fa-trash mr-1"></i> Uninstall
                        </button>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-span-full py-12 text-center">
                <div class="bg-gray-100 border-2 border-dashed rounded-xl w-16 h-16 mx-auto mb-4"></div>
                <h3 class="text-lg font-medium text-gray-900">No plugins installed</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by installing a plugin.</p>
                <div class="mt-6">
                    <button id="install-first-plugin"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-500 hover:bg-primary-600">
                        <i class="fas fa-plus-circle mr-2"></i> Install Plugin
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- 安装插件模态框 -->
<div id="install-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md fade-in">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Install New Plugin</h3>
        </div>
        <div class="px-6 py-4">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Installation Method</label>
                <div class="flex space-x-4">
                    <button id="upload-method"
                            class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-upload mr-2"></i> Upload Package
                    </button>
                    <button id="url-method"
                            class="flex-1 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-link mr-2"></i> From URL
                    </button>
                </div>
            </div>

            <div id="upload-section" class="hidden">
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Plugin Package</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                 viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="file-upload"
                                       class="relative cursor-pointer bg-white rounded-md font-medium text-primary-500 hover:text-primary-600">
                                    <span>Upload a file</span>
                                    <input id="file-upload" name="file-upload" type="file" class="sr-only">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">ZIP, TAR.GZ up to 10MB</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="url-section" class="hidden">
                <div class="mt-4">
                    <label for="plugin-url" class="block text-sm font-medium text-gray-700 mb-1">Repository URL</label>
                    <input type="text" id="plugin-url"
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                           placeholder="https://github.com/user/flask-plugin">
                </div>
            </div>
        </div>
        <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
            <button id="cancel-install"
                    class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Cancel
            </button>
            <button id="confirm-install"
                    class="px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-500 hover:bg-primary-600">
                Install Plugin
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 插件开关切换
        document.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const pluginName = this.dataset.plugin;
                const isEnabled = this.checked;

                fetch(`/api/plugins/toggle/${pluginName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({state: isEnabled})
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // 显示成功消息
                            showNotification(`Plugin ${isEnabled ? 'enabled' : 'disabled'} successfully`, 'success');
                        } else {
                            // 恢复原始状态并显示错误
                            this.checked = !isEnabled;
                            showNotification(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        this.checked = !isEnabled;
                        showNotification('Failed to update plugin status', 'error');
                    });
            });
        });

        // 卸载插件按钮
        document.querySelectorAll('.delete-plugin').forEach(button => {
            button.addEventListener('click', function () {
                const pluginName = this.dataset.plugin;
                if (confirm(`Are you sure you want to uninstall ${pluginName}? This cannot be undone.`)) {
                    fetch(`/api/plugins/uninstall/${pluginName}`, {
                        method: 'DELETE'
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // 移除插件卡片
                                const card = this.closest('.plugin-card');
                                card.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                                setTimeout(() => card.remove(), 300);
                                showNotification(`Plugin ${pluginName} uninstalled successfully`, 'success');
                            } else {
                                showNotification(data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showNotification('Failed to uninstall plugin', 'error');
                        });
                }
            });
        });

        // 安装插件按钮
        const installBtn = document.getElementById('install-plugin-btn');
        const firstInstallBtn = document.getElementById('install-first-plugin');
        const installModal = document.getElementById('install-modal');
        const cancelInstall = document.getElementById('cancel-install');
        const confirmInstall = document.getElementById('confirm-install');
        const uploadMethod = document.getElementById('upload-method');
        const urlMethod = document.getElementById('url-method');
        const uploadSection = document.getElementById('upload-section');
        const urlSection = document.getElementById('url-section');

        if (installBtn) installBtn.addEventListener('click', () => installModal.classList.remove('hidden'));
        if (firstInstallBtn) firstInstallBtn.addEventListener('click', () => installModal.classList.remove('hidden'));

        cancelInstall.addEventListener('click', () => installModal.classList.add('hidden'));

        // 关闭模态框
        installModal.addEventListener('click', (e) => {
            if (e.target === installModal) {
                installModal.classList.add('hidden');
            }
        });

        // 安装方法切换
        uploadMethod.addEventListener('click', () => {
            uploadSection.classList.remove('hidden');
            urlSection.classList.add('hidden');
            uploadMethod.classList.add('border-primary-500', 'bg-primary-50');
            urlMethod.classList.remove('border-primary-500', 'bg-primary-50');
        });

        urlMethod.addEventListener('click', () => {
            urlSection.classList.remove('hidden');
            uploadSection.classList.add('hidden');
            urlMethod.classList.add('border-primary-500', 'bg-primary-50');
            uploadMethod.classList.remove('border-primary-500', 'bg-primary-50');
        });

        // 确认安装
        confirmInstall.addEventListener('click', () => {
            // 实际应用中这里会发送安装请求
            installModal.classList.add('hidden');
            showNotification('Plugin installation started. This may take a few moments.', 'info');

            // 模拟安装过程
            setTimeout(() => {
                showNotification('Plugin installed successfully!', 'success');
                // 在实际应用中，这里会刷新页面或添加新插件卡片
            }, 2000);
        });

        // 显示通知函数
        function showNotification(message, type) {
            // 移除现有的通知
            const existingNotice = document.getElementById('global-notice');
            if (existingNotice) existingNotice.remove();

            // 创建通知元素
            const notice = document.createElement('div');
            notice.id = 'global-notice';
            notice.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md shadow-lg text-white font-medium ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            notice.textContent = message;
            notice.style.animation = 'fadeIn 0.3s ease-in-out';

            document.body.appendChild(notice);

            // 3秒后移除通知
            setTimeout(() => {
                notice.style.animation = 'fadeOut 0.3s ease-in-out forwards';
                setTimeout(() => notice.remove(), 300);
            }, 3000);
        }

        // 添加fadeOut动画
        const style = document.createElement('style');
        style.textContent = `
                @keyframes fadeOut {
                    from { opacity: 1; transform: translateY(0); }
                    to { opacity: 0; transform: translateY(-10px); }
                }
            `;
        document.head.appendChild(style);
    });
</script>
</body>
</html>
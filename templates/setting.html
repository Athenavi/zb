<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户设置中心</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .setting-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .setting-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .avatar-upload:hover .avatar-overlay {
            opacity: 1;
        }

        .crop-container {
            max-height: 60vh;
            overflow: hidden;
        }

        .save-btn {
            transition: all 0.2s ease;
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .setting-nav a.active {
            background-color: #f0f9ff;
            color: #0ea5e9;
            font-weight: 500;
        }

        .setting-nav a:hover:not(.active) {
            background-color: #f9fafb;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Navigation Bar -->
{% from 'header.html' import SimpleHeader %}
{{ SimpleHeader(title) }}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col lg:flex-row gap-6">
        <!-- 左侧导航 -->
        <div class="w-full lg:w-64">
            <div class="bg-white rounded-xl shadow-sm setting-card p-4">
                <div class="space-y-1">
                    <h4 class="text-lg font-bold mt-2 px-2 py-1">设置中心</h4>
                    <nav class="space-y-1 setting-nav">
                        <a href="#" onclick="showSection('profile')"
                           class="block p-3 text-gray-700 rounded-lg transition-colors active">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                个人资料
                            </div>
                        </a>
                        <a href="#" onclick="showSection('private')"
                           class="block p-3 text-gray-700 rounded-lg transition-colors">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                隐私设置
                            </div>
                        </a>
                        <a href="#" onclick="window.open('/diy/space', '_blank')"
                           class="block p-3 text-gray-700 rounded-lg transition-colors">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                </svg>
                                自定义空间
                            </div>
                        </a>
                        <a href="#" onclick="showSection('c_password')"
                           class="block p-3 text-gray-700 rounded-lg transition-colors">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                                修改密码
                            </div>
                        </a>
                        <a onclick="fun_logout()"
                           class="block p-3 text-red-600 hover:bg-red-50 rounded-lg cursor-pointer transition-colors">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                注销登录
                            </div>
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <!-- 右侧内容区域 -->
        <div class="flex-1">
            <!-- 个人资料部分 -->
            <div id="profile" class="section">
                <div class="bg-white rounded-xl shadow-sm setting-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">个人资料设置</h2>
                    <p class="text-gray-500 mb-6">管理您的个人资料信息</p>

                    <div class="flex flex-col items-center mb-8">
                        <div class="avatar-upload relative mb-3"
                             onclick="document.getElementById('avatarInput').click()">
                            <img src="{{ domain }}static/avatar/{{ avatar_url }}.webp"
                                 alt="头像"
                                 class="h-32 w-32 rounded-full cursor-pointer ring-4 ring-white shadow-lg"
                                 id="avatarImage"/>
                            <div class="avatar-overlay">
                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <input type="file" id="avatarInput" class="hidden" accept="image/*"
                               onchange="showCropModal(event)"/>
                        <p class="text-gray-500 text-sm">支持 JPG, PNG 格式，大小不超过 5MB</p>
                    </div>

                    <!-- 裁剪模态框 -->
                    <div id="avatarCropModal"
                         class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl">
                            <div class="p-4 border-b flex justify-between items-center">
                                <h5 class="text-lg font-semibold">裁剪头像</h5>
                                <button onclick="closeCropModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                    &times;
                                </button>
                            </div>
                            <div class="p-4 crop-container">
                                <img id="cropImage" src="" alt="预览" class="max-w-full"/>
                            </div>
                            <div class="p-4 border-t flex justify-end gap-2">
                                <button onclick="closeCropModal()"
                                        class="px-4 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                                    取消
                                </button>
                                <button id="cropButton"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    确认裁剪
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- 用户名 -->
                        <div class="bg-gray-50 rounded-xl p-5">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-800 mb-1">用户名</h3>
                                    <p class="text-gray-500 text-sm">设置一个独特的用户名，4-16个字符</p>
                                </div>
                                <div class="w-full md:w-64">
                                    <input type="text" id="usernameInput" value="{{ username }}"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                    >
                                </div>
                                <button onclick="updateUsername()"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors save-btn whitespace-nowrap"
                                        {% if limit_username_lock %}disabled{% endif %}>
                                    更新用户名
                                </button>
                            </div>
                        </div>

                        <!-- 电子邮箱 -->
                        <div class="bg-gray-50 rounded-xl p-5">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-800 mb-1">电子邮箱</h3>
                                    <p class="text-gray-500 text-sm">当前绑定邮箱: {{ userEmail }}</p>
                                </div>
                                <button onclick="changeEmail()"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors save-btn whitespace-nowrap">
                                    换绑邮箱
                                </button>
                            </div>
                        </div>

                        <!-- 个人简介 -->
                        <div class="bg-gray-50 rounded-xl p-5">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="w-full">
                                    <h3 class="font-medium text-gray-800 mb-1">个人简介</h3>
                                    <p class="text-gray-500 text-sm">用一段话介绍你自己</p>
                                    <textarea rows="3" id="bioInput"
                                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">{{ Bio }}</textarea>
                                </div>
                                <button onclick="updateBio()"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors save-btn whitespace-nowrap">
                                    保存简介
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 隐私设置部分 -->
            <div id="private" class="section hidden">
                <div class="bg-white rounded-xl shadow-sm setting-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">隐私设置</h2>
                    <div class="space-y-6">
                        <!-- 公开资料 -->
                        <div class="bg-gray-50 rounded-xl p-5">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-800 mb-1">公开资料</h3>
                                    <p class="text-gray-500 text-sm">选择是否公开您的个人资料</p>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="publicProfileInput" class="form-checkbox"
                                           {% if ProfilePrivate != true %}checked{% endif %}>
                                    <label for="publicProfileInput" class="ml-2 text-gray-500 text-sm">公开</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 修改密码部分 -->
            <div id="c_password" class="section hidden">
                <iframe src="/change-password" frameborder="0" style="height: 85vh; width: 100%;"
                        class="w-full h-full"></iframe>
            </div>
        </div>
    </div>
</div>
<!-- Footer -->
{% from 'footer.html' import SimpleFooter %}
{{ SimpleFooter(SiteName,beian) }}

<script>
    function showSection(section) {
        // 获取所有的设置部分
        const sections = document.querySelectorAll('.section');

        // 遍历所有的设置部分，并隐藏他们
        sections.forEach(sec => {
            sec.classList.add('hidden');
        });

        // 显示指定的部分
        const targetSection = document.getElementById(section);
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }

        // 更新导航栏中active状态的链接
        const links = document.querySelectorAll('.setting-nav a');
        links.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('onclick').includes(section)) {
                link.classList.add('active');
            }
        });
    }
</script>
<script>
    // 全局变量
    let cropper;
    const API_BASE = '/setting/profiles';

    // 裁剪功能
    function showCropModal(event) {
        const file = event.target.files[0];
        if (!file) return;

        // 验证文件类型和大小
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            Swal.fire({
                icon: 'error',
                title: '文件格式错误',
                text: '请上传 JPG、PNG 或 WEBP 格式的图片',
            });
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            Swal.fire({
                icon: 'error',
                title: '文件太大',
                text: '图片大小不能超过 5MB',
            });
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.getElementById('cropImage');
            img.src = e.target.result;
            document.getElementById('avatarCropModal').classList.remove('hidden');

            // 初始化裁剪器
            cropper = new Cropper(img, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 0.8,
                minCropBoxWidth: 100,
                minCropBoxHeight: 100,
            });
        };
        reader.readAsDataURL(file);
    }

    function closeCropModal() {
        document.getElementById('avatarCropModal').classList.add('hidden');
        if (cropper) {
            cropper.destroy();
        }
    }

    document.getElementById('cropButton').addEventListener('click', () => {
        const canvas = cropper.getCroppedCanvas();
        canvas.toBlob((blob) => {
            // 显示加载状态
            Swal.fire({
                title: '上传中...',
                html: '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div></div>',
                showConfirmButton: false,
                allowOutsideClick: false
            });

            // 创建FormData并发送请求
            const formData = new FormData();
            formData.append('avatar', blob, 'avatar.webp');

            fetch(`${API_BASE}?change_type=avatar`, {
                method: 'PUT',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Avatar updated successfully') {
                        // 更新头像预览
                        document.getElementById('avatarImage').src = URL.createObjectURL(blob);
                        Swal.fire({
                            icon: 'success',
                            title: '头像更新成功',
                            text: '您的新头像已保存',
                            showConfirmButton: false,
                            timer: 2000
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: '上传失败',
                            text: data.error || '未知错误'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: '上传失败',
                        text: error.message
                    });
                })
                .finally(() => {
                    closeCropModal();
                });
        }, 'image/webp', 0.9);
    });

    // 更新用户名
    function updateUsername() {
        const username = document.getElementById('usernameInput').value;

        // 客户端验证
        if (!username) {
            Swal.fire({
                icon: 'error',
                title: '用户名不能为空',
                text: '请输入有效的用户名'
            });
            return;
        }

        if (!/^[a-zA-Z0-9_]{4,16}$/.test(username)) {
            Swal.fire({
                icon: 'error',
                title: '格式错误',
                text: '用户名应为4-16个字符，只能包含字母、数字和下划线'
            });
            return;
        }

        Swal.fire({
            title: '更新用户名',
            text: '确定要更新用户名吗？（一周内可进行一次修改）',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '确认更新',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                // 显示加载状态
                Swal.fire({
                    title: '更新中...',
                    html: '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div></div>',
                    showConfirmButton: false,
                    allowOutsideClick: false
                });

                // 发送请求到后端
                fetch(`${API_BASE}?change_type=username`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({username})
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === 'Username updated successfully') {
                            Swal.fire({
                                icon: 'success',
                                title: '用户名已更新',
                                text: '您的新用户名已保存',
                                showConfirmButton: false,
                                timer: 1500
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '更新失败',
                                text: data.error || '未知错误'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: '更新失败',
                            text: error.message
                        });
                    });
            }
        });
    }

    // 换绑邮箱
    function changeEmail() {
        Swal.fire({
            title: '换绑邮箱',
            html: `
                    <div class="text-left">
                        <p class="text-gray-600 mb-3">请输入您的新邮箱地址</p>
                        <input id="swal-input" type="email" class="swal2-input" placeholder="new@example.com">
                        <p class="text-gray-500 text-sm mt-3">我们将发送验证邮件到该邮箱</p>
                    </div>
                `,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: '发送验证邮件',
            cancelButtonText: '取消',
            preConfirm: () => {
                const email = document.getElementById('swal-input').value;
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                    Swal.showValidationMessage('请输入有效的邮箱地址');
                    return false;
                }
                return email;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // 显示加载状态
                Swal.fire({
                    title: '处理中...',
                    html: '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div></div>',
                    showConfirmButton: false,
                    allowOutsideClick: false
                });

                // 发送请求到后端
                fetch(`${API_BASE}?change_type=email`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({email: result.value})
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === 'Email updated successfully') {
                            Swal.fire({
                                title: '验证邮件已发送',
                                text: `我们已向 ${result.value} 发送了验证邮件，请查收`,
                                icon: 'success',
                                confirmButtonText: '好的'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '操作失败',
                                text: data.error || '未知错误'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: '操作失败',
                            text: error.message
                        });
                    });
            }
        });
    }

    // 更新个人简介
    function updateBio() {
        const bio = document.getElementById('bioInput').value;

        // 显示加载状态
        Swal.fire({
            title: '保存中...',
            html: '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div></div>',
            showConfirmButton: false,
            allowOutsideClick: false
        });

        // 发送请求到后端
        fetch(`${API_BASE}?change_type=bio`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({bio})
        })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Bio updated successfully') {
                    Swal.fire({
                        icon: 'success',
                        title: '个人简介已保存',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '保存失败',
                        text: data.error || '未知错误'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: '保存失败',
                    text: error.message
                });
            });
    }

    // 注销登录
    function fun_logout() {
        Swal.fire({
            title: '确定要注销登录吗？',
            text: '注销后需要重新登录才能访问',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '确认注销',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                // 模拟注销过程
                Swal.fire({
                    title: '正在注销...',
                    timer: 1000,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                }).then(() => {
                    window.location.href = "/logout";
                });
            }
        });
    }
</script>
</body>
</html>
<!-- templates/comments.html -->
<link rel="stylesheet" href="/static/css/tailwind.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body {
        overflow-y: hidden;
        overflow-x: hidden;
    }

    ::-webkit-scrollbar {
        display: none;
    }
</style>
<style>
    .comment-item {
        transition: all 0.3s ease;
        position: relative;
    }

    .comment-item:hover {
        background-color: #f9fafb;
    }

    .reply-highlight {
        animation: highlight 1.5s ease;
        border-left: 3px solid #3b82f6;
    }

    @keyframes highlight {
        0% {
            background-color: rgba(59, 130, 246, 0.1);
        }
        100% {
            background-color: transparent;
        }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .max-iframe-height {
        max-height: 600px;
        overflow-y: auto;
    }

    .floor-number {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: #f1f5f9;
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #475569;
    }

    .reply-info {
        background: #f0f9ff;
        border-left: 3px solid #0ea5e9;
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.75rem;
        border-radius: 0 4px 4px 0;
        font-size: 0.875rem;
        color: #0369a1;
    }

    @media (max-width: 640px) {
        .floor-number {
            position: static;
            display: inline-block;
            margin-left: 0.5rem;
        }

        .comment-header {
            flex-wrap: wrap;
        }

        .comment-actions {
            width: 100%;
            margin-top: 0.5rem;
        }
    }
</style>

<div class="comment-section max-w-3xl mx-auto py-6">
    <!-- 评论表单 -->
    <div class="comment-form rounded-lg shadow-sm p-4 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-pen mr-2 text-blue-500"></i>发表评论
        </h3>
        <form id="commentForm" class="space-y-3">
            <input type="hidden" name="article_id" value="{{ article.article_id }}">
            <input type="hidden" name="parent_id" id="replyTo" value="">

            <div class="form-group">
                <textarea
                        name="content"
                        id="commentContent"
                        rows="3"
                        class="w-full px-4 py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        placeholder="写下您的评论..."
                        required
                ></textarea>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                <div class="reply-indicator hidden w-full sm:w-auto" id="replyIndicator">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 flex items-center">
                        <span class="text-sm text-blue-700">
                            回复 <span id="replyUsername" class="font-medium"></span> 的评论
                        </span>
                        <button type="button" id="cancelReply"
                                class="ml-2 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </div>
                <button
                        type="submit"
                        class="px-5 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors w-full sm:w-auto flex items-center justify-center"
                >
                    <i class="fas fa-paper-plane mr-2"></i>发布评论
                </button>
            </div>
        </form>
    </div>

    <!-- 评论列表 -->
    <div id="commentsContainer" class="max-iframe-height">
        {% if comments_tree %}
            <div id="commentsList" class="space-y-4">
                {% for comment in comments_tree %}
                    {% include 'comment_item.html' %}
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8">
                <i class="fas fa-comment-slash text-3xl text-gray-300 mb-3"></i>
                <p class="text-gray-500">暂无评论，成为第一个评论者吧！</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const commentForm = document.getElementById('commentForm');
        const replyTo = document.getElementById('replyTo');
        const replyIndicator = document.getElementById('replyIndicator');
        const replyUsername = document.getElementById('replyUsername');
        const cancelReplyBtn = document.getElementById('cancelReply');
        const commentContent = document.getElementById('commentContent');

        // 回复按钮事件
        document.addEventListener('click', function (e) {
            if (e.target.closest('.reply-btn')) {
                const btn = e.target.closest('.reply-btn');
                const commentId = btn.dataset.id;
                const username = btn.dataset.username;
                const floor = btn.dataset.floor;

                replyTo.value = commentId;
                replyUsername.textContent = username;
                replyIndicator.classList.remove('hidden');

                // 在文本框中添加回复提示
                commentContent.value = `回复 #${floor}：`;
                commentContent.focus();
                commentContent.setSelectionRange(commentContent.value.length, commentContent.value.length);

                // 滚动到表单
                commentForm.scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        });

        // 取消回复
        cancelReplyBtn.addEventListener('click', function () {
            replyTo.value = '';
            replyIndicator.classList.add('hidden');
            commentContent.value = '';
        });

        // 表单提交
        commentForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>发布中...';

                const response = await fetch('/api/comment/{{ article.article_id }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(Object.fromEntries(formData))
                });

                const result = await response.json();

                if (response.ok) {
                    // 成功处理 - 重新加载页面
                    window.location.reload();
                } else {
                    throw new Error(result.error || '发布评论失败');
                }
            } catch (error) {
                alert(error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // 点击评论项可以快速回复（移动端友好）
        document.addEventListener('click', function (e) {
            if (e.target.closest('.comment-item') && !e.target.closest('.reply-btn')) {
                const commentItem = e.target.closest('.comment-item');
                const replyBtn = commentItem.querySelector('.reply-btn');

                if (replyBtn && window.innerWidth < 640) {
                    const commentId = replyBtn.dataset.id;
                    const username = replyBtn.dataset.username;
                    const floor = replyBtn.dataset.floor;

                    replyTo.value = commentId;
                    replyUsername.textContent = username;
                    replyIndicator.classList.remove('hidden');

                    commentContent.value = `回复 #${floor}：`;
                    commentContent.focus();
                    commentContent.setSelectionRange(commentContent.value.length, commentContent.value.length);

                    commentForm.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            }
        });
    });
</script>
{% extends "base.html" %}

{% block title %}系统初始化引导 - {{ super() }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- 步骤指示器 -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                {% for step in steps %}
                <div class="flex flex-col items-center flex-1">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center
                                {% if loop.index0 == current_step %}
                                bg-blue-600 text-white
                                {% elif loop.index0 < current_step %}
                                bg-green-500 text-white
                                {% else %}
                                bg-gray-300 text-gray-600
                                {% endif %}">
                        {{ loop.index }}
                    </div>
                    <div class="mt-2 text-sm text-center">
                        <div class="font-medium {% if loop.index0 == current_step %} text-blue-600 {% endif %}">
                            {{ step.title }}
                        </div>
                        <div class="text-gray-500 text-xs hidden sm:block">
                            {{ step.description }}
                        </div>
                    </div>
                </div>
                {% if not loop.last %}
                <div class="flex-1 h-1 {% if loop.index0 < current_step %} bg-green-500 {% else %} bg-gray-300 {% endif %}"></div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <!-- 欢迎步骤 -->
            <div id="step-welcome" class="step-content {% if current_step != 0 %} hidden {% endif %}">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">欢迎使用系统初始化引导</h2>
                <div class="prose prose-blue max-w-none">
                    <p class="text-gray-600 mb-6">
                        本引导将帮助您完成系统的初始配置。请按照步骤完成所有必要的设置。
                    </p>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">配置清单</h3>
                        <ul class="list-disc list-inside text-blue-700 space-y-1">
                            <li>数据库连接配置</li>
                            <li>应用基础设置</li>
                            <li>管理员账户创建</li>
                            <li>可选功能配置</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-2">准备工作</h3>
                        <ul class="list-disc list-inside text-yellow-700 space-y-1">
                            <li>确保数据库服务已启动</li>
                            <li>准备好域名和网站标题</li>
                            <li>确保有文件写入权限</li>
                        </ul>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="nextStep()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        开始配置
                    </button>
                </div>
            </div>

            <!-- 数据库配置步骤 -->
            <div id="step-database" class="step-content hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">数据库配置</h2>
                <p class="text-gray-600 mb-6">请填写数据库连接信息</p>

                <form id="database-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">数据库引擎</label>
                            <select name="db_engine" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="postgresql" selected>PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">主机地址</label>
                            <input type="text" name="db_host" value="localhost"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">端口</label>
                            <input type="number" name="db_port" value="5432"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">数据库名</label>
                            <input type="text" name="db_name" value="flaskblog"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                            <input type="text" name="db_user" value="postgres"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                            <input type="password" name="db_password"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">连接池大小</label>
                        <input type="number" name="db_pool_size" value="16"
                               class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mt-8 flex justify-between">
                        <button type="button" onclick="prevStep()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            上一步
                        </button>
                        <div class="space-x-4">
                            <button type="button" onclick="testDatabase()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                测试连接
                            </button>
                            <button type="button" onclick="saveDatabaseConfig()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                保存并继续
                            </button>
                        </div>
                    </div>
                </form>

                <div id="db-test-result" class="mt-4 hidden"></div>
            </div>

            <!-- 应用配置步骤 -->
            <div id="step-app" class="step-content hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">应用配置</h2>
                <p class="text-gray-600 mb-6">请填写应用基础信息</p>

                <form id="app-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">网站域名</label>
                        <input type="url" name="domain" placeholder="https://example.com/"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="text-sm text-gray-500 mt-1">请以斜杠结尾，例如: https://7trees.cn/</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">网站标题</label>
                        <input type="text" name="title" placeholder="我的博客"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">备案号</label>
                        <input type="text" name="beian" placeholder="京ICP备12345678号"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">JWT 过期时间（秒）</label>
                            <input type="number" name="jwt_expiration" value="604800"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Refresh Token 过期时间（秒）</label>
                            <input type="number" name="refresh_expiration" value="604800"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SECRET_KEY</label>
                        <div class="flex space-x-2">
                            <input type="text" name="secret_key"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                            <button type="button" onclick="generateSecretKey()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                生成
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">用于加密会话的安全密钥，请妥善保管</p>
                    </div>
                </form>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        上一步
                    </button>
                    <button onclick="saveAppConfig()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        保存并继续
                    </button>
                </div>
            </div>

            <!-- 管理员配置步骤 -->
            <div id="step-admin" class="step-content hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">创建管理员账户</h2>
                <p class="text-gray-600 mb-6">请设置初始管理员账户信息</p>

                <form id="admin-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                        <input type="text" name="admin_username" placeholder="admin"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">邮箱</label>
                        <input type="email" name="admin_email"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                            <input type="password" name="admin_password"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">确认密码</label>
                            <input type="password" name="admin_confirm_password"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                </form>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        上一步
                    </button>
                    <button onclick="saveAdminConfig()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        保存并继续
                    </button>
                </div>
            </div>

            <!-- 可选配置步骤 -->
            <div id="step-optional" class="step-content hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">可选配置</h2>
                <p class="text-gray-600 mb-6">以下配置可选，可在系统运行后随时修改</p>

                <div class="space-y-8">
                    <!-- 邮件配置 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">邮件服务器配置</h3>
                        <form id="mail-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SMTP 主机</label>
                                <input type="text" name="mail_host" placeholder="smtp.163.com"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">端口</label>
                                <input type="number" name="mail_port" value="465"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">邮箱地址</label>
                                <input type="email" name="mail_user" placeholder="support@7trees.cn"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">邮箱密码/授权码</label>
                                <input type="password" name="mail_password"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </form>
                    </div>

                    <!-- Redis配置 -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Redis 配置</h3>
                        <form id="redis-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Redis 主机</label>
                                <input type="text" name="redis_host" value="localhost"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">端口</label>
                                <input type="number" name="redis_port" value="6379"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">密码</label>
                                <input type="password" name="redis_password"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">数据库编号</label>
                                <input type="number" name="redis_db" value="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </form>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        上一步
                    </button>
                    <button onclick="saveOptionalConfig()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        保存并继续
                    </button>
                </div>
            </div>

            <!-- 完成步骤 -->
            <div id="step-complete" class="step-content hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">系统初始化完成</h2>

                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-green-800 font-medium">配置已成功保存！</span>
                    </div>
                </div>

                <div class="prose prose-blue max-w-none mb-6">
                    <p class="text-gray-600">系统配置文件已生成，接下来需要重启应用以使配置生效。</p>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">重启说明</h3>
                        <div id="restart-commands" class="text-blue-700 space-y-2">
                            <!-- 重启命令将通过 JavaScript 动态加载 -->
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        上一步
                    </button>
                    <button onclick="showRestartInfo()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        查看重启说明
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 0;
const steps = {{ steps | tojson }};
const configData = {};

function showStep(stepIndex) {
    // 隐藏所有步骤
    document.querySelectorAll('.step-content').forEach(el => {
        el.classList.add('hidden');
    });

    // 显示当前步骤
    const stepId = `step-${steps[stepIndex].id}`;
    document.getElementById(stepId).classList.remove('hidden');

    // 更新步骤指示器
    updateStepIndicator(stepIndex);

    currentStep = stepIndex;
}

function updateStepIndicator(stepIndex) {
    // 这里可以添加步骤指示器的视觉更新逻辑
    console.log(`当前步骤: ${stepIndex + 1}`);
}

function nextStep() {
    if (currentStep < steps.length - 1) {
        showStep(currentStep + 1);
    }
}

function prevStep() {
    if (currentStep > 0) {
        showStep(currentStep - 1);
    }
}

// 数据库连接测试
async function testDatabase() {
    const form = document.getElementById('database-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    const resultDiv = document.getElementById('db-test-result');

    try {
        const response = await fetch('/guide/test-db', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            resultDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-green-800">${result.message}</span>
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <span class="text-red-800">${result.message}</span>
                    </div>
                </div>
            `;
        }

        resultDiv.classList.remove('hidden');
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <span class="text-red-800">测试连接失败: ${error.message}</span>
            </div>
        `;
        resultDiv.classList.remove('hidden');
    }
}

// 生成 SECRET_KEY
async function generateSecretKey() {
    try {
        const response = await fetch('/guide/generate-secret', {
            method: 'POST'
        });

        const result = await response.json();
        document.querySelector('input[name="secret_key"]').value = result.secret_key;
    } catch (error) {
        alert('生成 SECRET_KEY 失败: ' + error.message);
    }
}

// 保存数据库配置
function saveDatabaseConfig() {
    const form = document.getElementById('database-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // 保存到全局配置对象
    Object.assign(configData, data);

    nextStep();
}

// 保存应用配置
function saveAppConfig() {
    const form = document.getElementById('app-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    Object.assign(configData, data);
    nextStep();
}

// 保存管理员配置
function saveAdminConfig() {
    const form = document.getElementById('admin-form');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // 验证密码
    if (data.admin_password !== data.admin_confirm_password) {
        alert('两次输入的密码不一致');
        return;
    }

    configData.admin = data;
    nextStep();
}

// 保存可选配置
function saveOptionalConfig() {
    // 邮件配置
    const mailForm = document.getElementById('mail-form');
    const mailData = Object.fromEntries(new FormData(mailForm).entries());
    Object.assign(configData, mailData);

    // Redis配置
    const redisForm = document.getElementById('redis-form');
    const redisData = Object.fromEntries(new FormData(redisForm).entries());
    Object.assign(configData, redisData);

    // 保存所有配置
    saveAllConfig();
}

// 保存所有配置
async function saveAllConfig() {
    try {
        configData.step = 'complete';

        const response = await fetch('/guide/save-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(configData)
        });

        const result = await response.json();

        if (result.success) {
            nextStep();
        } else {
            alert('保存配置失败: ' + result.message);
        }
    } catch (error) {
        alert('保存配置失败: ' + error.message);
    }
}

// 显示重启信息
async function showRestartInfo() {
    try {
        const response = await fetch('/guide/restart-info');
        const result = await response.json();

        const commandsDiv = document.getElementById('restart-commands');
        commandsDiv.innerHTML = result.commands.map(cmd =>
            `<div class="font-mono text-sm bg-white p-2 rounded border">${cmd}</div>`
        ).join('');
    } catch (error) {
        alert('获取重启信息失败: ' + error.message);
    }
}

// 初始化页面
document.addEventListener('DOMContentLoaded', function() {
    showStep(0);
    generateSecretKey(); // 自动生成 SECRET_KEY
});
</script>
{% endblock %}